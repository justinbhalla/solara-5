<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solara – Adaptive Workspace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    .fade-in { animation: fadeIn .25s ease-in-out; }
    @keyframes fadeIn { from { opacity:.0; } to { opacity:1; } }
    .drag-over { background-color: rgba(99,102,241,.08); outline: 2px dashed #6366f1; outline-offset: -2px; }
    .menu-card { box-shadow: 0 10px 20px rgba(0,0,0,.08); }
    .editable { outline: none; min-height: 1.5rem; }
    .dragging { opacity: .6; transform: rotate(.5deg); }
    .drop-indicator { height: .5rem; border-radius: .25rem; background: rgba(99,102,241,.45); margin: .25rem 0; display: none; }
    .show-drop .drop-indicator { display: block; }
    .date-badge { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">

  <!-- Top status banner -->
  <div id="statusBanner" class="hidden bg-amber-50 text-amber-900 border-b border-amber-200 px-6 py-2 text-sm"></div>

  <!-- Header -->
  <header class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
    <div class="flex items-center gap-3">
      <a href="workspaces.html" class="w-9 h-9 rounded-xl bg-indigo-600/10 text-indigo-600 flex items-center justify-center hover:bg-indigo-600/20" title="All Workspaces">🔷</a>
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Solara</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400">Part of the ZLG Product Suite</p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <!-- Workspace switcher -->
      <div class="hidden sm:flex items-center gap-2">
        <label for="wsSelect" class="text-xs text-gray-500">Workspace</label>
        <select id="wsSelect" class="text-sm px-2 py-1 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 min-w-[14rem]"></select>
        <button id="reloadBtn" class="px-2 py-1 rounded-lg border border-gray-300 dark:border-gray-700 text-sm hover:bg-gray-50 dark:hover:bg-gray-800" title="Reload from cloud">Reload</button>
      </div>

      <!-- User -->
      <div id="userArea" class="relative">
        <button id="userButton" class="flex items-center gap-2 px-3 py-2 rounded-full border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
          <span id="avatar" class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-indigo-600 text-white text-xs font-semibold">?</span>
          <span id="userName" class="text-sm font-medium">User</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
        </button>
        <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 rounded-xl menu-card bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 overflow-hidden">
          <div class="px-4 py-3 text-sm">
            <div id="userEmail" class="text-gray-600 dark:text-gray-300"></div>
          </div>
          <div class="border-t border-gray-100 dark:border-gray-700"></div>
          <button id="addUserBtn" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700">Add user…</button>
          <button id="signOutBtn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Nav bar -->
  <nav class="flex items-center justify-between px-6 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm font-medium">
    <div class="flex items-center gap-6">
      <button class="flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-semibold">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3h14v2H3V3zm0 4h9v2H3V7zm0 4h14v2H3v-2zm0 4h9v2H3v-2z"/></svg>
        <span>Tasks</span>
      </button>
      <!-- Restored Reports tab -->
      <button id="reportsBtn" onclick="openReports()" class="flex items-center gap-2 text-gray-700 dark:text-gray-200 hover:text-indigo-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M7 16v-4m4 4V8m4 8V5"/></svg>
        <span>Reports</span>
      </button>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="clearAllTasks()" title="Clear all tasks in current tab" class="p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m0 0A2.99 2.99 0 017 6h10a2.99 2.99 0 012.418 3H19v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9h.582zM10 11v6m4-6v6"/></svg>
      </button>
      <button id="newTaskBtn" onclick="addNewTask()" class="px-4 py-1.5 text-sm rounded bg-indigo-600 text-white hover:bg-indigo-500 shadow transition">+</button>
    </div>
  </nav>

  <!-- Cloud / workspace breadcrumb -->
  <div class="px-6 py-2 text-xs text-gray-500 dark:text-gray-400">
    <span id="wsCrumb">–</span>
  </div>

  <!-- Main Board -->
  <main class="p-6 flex-1 overflow-y-auto">
    <div id="board" class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div id="todo" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="todo">
        <h2 class="text-lg font-semibold mb-2">To Do</h2>
        <div class="drop-indicator"></div>
      </div>
      <div id="inprogress" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="inprogress">
        <h2 class="text-lg font-semibold mb-2">In Progress</h2>
        <div class="drop-indicator"></div>
      </div>
      <div id="done" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="done">
        <h2 class="text-lg font-semibold mb-2">Done</h2>
        <div class="drop-indicator"></div>
      </div>
    </div>
  </main>

  <!-- Bottom rail (tabs left + export right) -->
  <div class="sticky bottom-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 z-50">
    <div class="flex items-center justify-between px-6 py-3 overflow-x-auto">
      <div class="flex items-center gap-2 w-full overflow-x-auto px-1 py-1">
        <div id="tabs" class="flex gap-2 min-w-max"></div>
        <button onclick="promptNewTab()" title="Add Tab" class="p-2 rounded-full bg-green-100 hover:bg-green-200 text-green-700 transition duration-150 shadow-sm border border-green-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        </button>
      </div>
      <div class="flex items-center gap-1">
        <button id="manageBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition" title="Manage members">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.57-.906 3.435.96 2.53 2.53a1.724 1.724 0 001.065 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.906 1.57-.96 3.435-2.53 2.53a1.724 1.724 0 00-2.573 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.57.906-3.435-.96-2.53-2.53A1.724 1.724 0 003.087 13.9c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.906-1.57.96-3.435 2.53-2.53.98.565 2.229.11 2.642-1.13zM12 9a3 3 0 110 6 3 3 0 010-6z"/></svg>
        </button>
        <button onclick="exportBoardAsPDF()" class="ml-1 p-2 rounded-full hover:bg-indigo-100 text-indigo-600 transition" title="Download Board">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm-7 4h14v-2H5v2z"/></svg>
        </button>
      </div>
    </div>
    <footer class="text-center text-xs text-gray-500 dark:text-gray-400 px-6 py-3 border-t border-gray-200 dark:border-gray-700">© 2025 ZenLock Group (ZLG). All rights reserved.</footer>
  </div>

  <!-- Members Manager Modal -->
  <div id="membersModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40" onclick="closeMembers()"></div>
    <div class="relative w-full max-w-lg rounded-2xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 p-5 shadow-xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Workspace Members</h3>
        <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800" onclick="closeMembers()" title="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="flex gap-2 mb-3">
        <input id="inviteEmail" type="email" placeholder="name@example.com" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm" />
        <button onclick="inviteMember()" class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 text-sm">Invite</button>
      </div>
      <div id="membersList" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
      <p class="text-xs text-gray-500 mt-3">Tip: If email is delayed or goes to Spam, use “Copy link” to share the invite URL directly.</p>
    </div>
  </div>

<script>
/*************************
 *  CONFIG               *
 *************************/
const API_BASE = "https://shy-smoke-ab8e.justinbhalla28.workers.dev"; // Worker origin
const apiUrl = (p) => API_BASE.replace(/\/+$/,'') + '/' + String(p||'').replace(/^\/+,'');
const POLL_MS = 3500; // lightweight convergence polling

/**************
 *  STATE     *
 **************/
let WORKSPACE_ID = '';
let WORKSPACE_NAME = '';
let workspaces = [];
let activeTab = null;
let tabData = {};
let sessionJWT = null;
let authedUser = null; // { name:{first_name,last_name}, email_addresses:[{email_address}] }
let currentUserKey = null; // user_id or email for namespacing
let dragContext = { id:null, fromCol:null, overCol:null, insertIndex:null };
let STORAGE_NS = null; // stable localStorage namespace
let currentRole = 'owner'; // 'owner' | 'editor' | 'viewer'
let pollTimer = null;

/*******************
 *  UTILITIES       *
 *******************/
const debounce = (fn, ms = 600) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
function q(sel){ return document.querySelector(sel) }
function showBanner(msg, color='amber'){ const el=q('#statusBanner'); el.textContent=msg; el.className=`bg-${color}-50 text-${color}-900 border-b border-${color}-200 px-6 py-2 text-sm`; el.classList.remove('hidden'); }
function hideBanner(){ const el=q('#statusBanner'); el.classList.add('hidden'); }
function qsParam(k){ return new URL(location.href).searchParams.get(k) }
function setQsParam(k,v){ const u = new URL(location.href); if(v==null||v==='') u.searchParams.delete(k); else u.searchParams.set(k,v); history.replaceState(null,'',u.toString()); }
function getSessionJWT(){
  const m = document.cookie.match(/(?:^|; )(?:stytch_session_jwt|solara_session_jwt)=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : (localStorage.getItem('stytch_session_jwt') || localStorage.getItem('solara_session_jwt') || null);
}
function computeStorageNS() {
  const uidFromAuth = currentUserKey || (authedUser?.email_addresses?.[0]?.email_address) || null;
  const widFromUrl  = WORKSPACE_ID || null;
  const cachedUid = localStorage.getItem('solara_last_uid') || 'anon';
  const cachedWid = localStorage.getItem('solara_last_ws')  || 'local';
  const uid = uidFromAuth || cachedUid;
  const wid = widFromUrl  || cachedWid;
  STORAGE_NS = `solara:tabs:${uid}:${wid}`;
  localStorage.setItem('solara_last_uid', uid);
  localStorage.setItem('solara_last_ws', wid);
}
function storageKey(){ if(!STORAGE_NS) computeStorageNS(); return STORAGE_NS; }
function normalizeDateString(input){
  if(!input) return '';
  if(typeof input === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(input)) return input;
  const d = new Date(input);
  if (isNaN(d)) return '';
  const tz = d.getTimezoneOffset()*60000;
  return new Date(d.getTime()-tz).toISOString().slice(0,10);
}
function loadTabsFromStorage(){
  try {
    const raw = localStorage.getItem(storageKey());
    const parsed = raw ? JSON.parse(raw) : {};
    return migrateTaskShapes(parsed);
  } catch { return {}; }
}
function saveTabsToStorage(){
  const key = storageKey();
  const json = JSON.stringify(tabData);
  try{ localStorage.setItem(key, json); localStorage.setItem('solara_tabs_backup', json); }catch(e){ console.warn('Local save failed, writing backup', e); try{ localStorage.setItem('solara_tabs_backup', json); }catch{} }
}
function initialsFor(user){
  const full = ((user?.name?.first_name||'') + ' ' + (user?.name?.last_name||'')).trim();
  const fromName = full.split(/\s+/).filter(Boolean).slice(0,2).map(s=>s[0]).join('');
  if(fromName) return fromName.toUpperCase();
  const email = user?.email_addresses?.[0]?.email_address || '?';
  return email.slice(0,2).toUpperCase();
}
function displayNameFor(user){
  const parts = [user?.name?.first_name, user?.name?.last_name].filter(Boolean);
  if (parts.length) return parts.join(' ');
  return user?.email_addresses?.[0]?.email_address || initialsFor(user);
}

/*******************
 *  LEGACY MIGRATION *
 *******************/
function migrateLegacyIfNeeded(){
  const newKey = storageKey();
  const existing = localStorage.getItem(newKey);
  if (existing) return; // already has namespaced data
  const legacy = localStorage.getItem('solara-tabs'); // old global key
  if (!legacy) return;
  try {
    const parsed = JSON.parse(legacy);
    if (parsed && typeof parsed === 'object') {
      localStorage.setItem(newKey, JSON.stringify(parsed));
      console.info('[Solara] Migrated legacy tabs →', newKey);
    }
  } catch {}
}

function migrateTaskShapes(data){
  const out = JSON.parse(JSON.stringify(data||{}));
  Object.keys(out||{}).forEach(tab => {
    ['todo','inprogress','done'].forEach(col => {
      out[tab][col] = (out[tab][col]||[]).map(t => ({
        id: t.id || `task-${Date.now()}`,
        content: typeof t.content === 'string' ? t.content : '',
        dueDate: normalizeDateString(t.dueDate),
        priority: ['High','Medium','Low'].includes(t.priority) ? t.priority : 'Medium'
      }));
    });
  });
  return out;
}

/*******************
 *  CLOUD SYNC      *
 *******************/
const saveTabsToCloud = debounce(async ()=>{
  if(!sessionJWT || !WORKSPACE_ID) return;
  if(currentRole === 'viewer') return; // viewers cannot write
  try{
    const res = await fetch(apiUrl('tasks'), {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${sessionJWT}` },
      body: JSON.stringify({ workspace_id: WORKSPACE_ID, tabs: tabData }),
      keepalive: true,
    });
    if(res.status === 401){ console.warn('Cloud save unauthorized'); return; }
    if(res.status === 403){ console.warn('Viewer cannot write'); return; }
    if(!res.ok) console.warn('Cloud save failed', await res.text());
    await loadTabsFromCloud(); renderTabs(); renderBoard(); // converge to server copy
  }catch(err){ console.warn('Cloud save error', err); }
}, 450);
async function flushCloudNow(){
  if(!sessionJWT || !WORKSPACE_ID || currentRole==='viewer') return;
  try{
    const r = await fetch(apiUrl('tasks'), {
      method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${sessionJWT}` },
      body: JSON.stringify({ workspace_id: WORKSPACE_ID, tabs: tabData }), keepalive: true,
    });
    if(r.ok){ await loadTabsFromCloud(); renderTabs(); renderBoard(); }
  }catch{}
}
async function loadTabsFromCloud(){
  if(!sessionJWT || !WORKSPACE_ID) return false;
  try{
    const url = apiUrl('tasks') + `?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`;
    const res = await fetch(url, { headers:{ 'Authorization':`Bearer ${sessionJWT}` } });
    if(res.status === 401) return false;
    if(res.status === 404){ showBanner('This workspace is not available to your account (404). Switch to another workspace or ask the owner to re-invite you.','red'); return false; }
    if(!res.ok) { showBanner('Could not load tasks. Please try Reload.','red'); return false; }
    const data = await res.json();
    if(!data || !data.tabs){ tabData = {}; saveTabsToStorage(); return true; }
    const cloud = migrateTaskShapes(data.tabs);
    tabData = cloud;                // CLOUD IS AUTHORITATIVE
    saveTabsToStorage();
    return true;
  }catch(err){ console.warn('Cloud load error', err); showBanner('Network error loading tasks.','red'); }
  return false;
}

/*******************
 *  AUTH & WORKSPACES *
 *******************/
function requireReauth(){
  try{
    localStorage.setItem('solara_last_uid', currentUserKey || localStorage.getItem('solara_last_uid') || 'anon');
    localStorage.setItem('solara_last_ws',  WORKSPACE_ID   || localStorage.getItem('solara_last_ws')  || 'local');
    computeStorageNS();
    saveTabsToStorage();
  }catch{}
  flushCloudNow().finally(()=>{
    try{
      localStorage.removeItem('stytch_session_jwt');
      localStorage.removeItem('solara_session_jwt');
    }catch{}
    location.replace('/sign-in.html');
  });
}
function hydrateFromAuthCheckPayload(data){
  const full = (data?.name||'').trim();
  const parts = full ? full.split(/\s+/) : [];
  const first = parts[0] || '';
  const last  = parts.slice(1).join(' ') || '';
  const email = data?.email || '';
  const uid   = data?.user_id || email || 'anon';
  currentUserKey = uid;
  computeStorageNS();
  return { name:{ first_name:first, last_name:last }, email_addresses: email ? [{ email_address: email }] : [] };
}
function updateAuthUI(){
  const avatar = document.getElementById('avatar');
  const nameEl = document.getElementById('userName');
  const emailEl = document.getElementById('userEmail');
  const u = authedUser || { name:{}, email_addresses:[] };
  avatar.textContent = initialsFor(u);
  nameEl.textContent = displayNameFor(u) || 'User';
  emailEl.textContent = u?.email_addresses?.[0]?.email_address || '';
}
function wireAuthButtons(){
  document.getElementById('userButton').onclick = () => document.getElementById('userMenu').classList.toggle('hidden');
  document.addEventListener('click', (e)=>{
    const m = document.getElementById('userMenu');
    const b = document.getElementById('userButton');
    if(!m.classList.contains('hidden') && !m.contains(e.target) && !b.contains(e.target)) m.classList.add('hidden');
  });
  document.getElementById('signOutBtn').onclick = async () => {
    try{ if(sessionJWT){ await fetch(apiUrl('logout'), { method:'POST', headers:{ 'Authorization':`Bearer ${sessionJWT}` } }).catch(()=>{}); } }
    finally{ requireReauth(); }
  };
  document.getElementById('addUserBtn').onclick = async () => { openMembers(); };
}

async function verifySessionAndHydrate(){
  sessionJWT = getSessionJWT();
  authedUser = JSON.parse(localStorage.getItem('stytch_user') || 'null');
  if(!sessionJWT) return false;
  updateAuthUI();
  try{
    const res = await fetch(apiUrl('auth/check'), { headers:{ 'Authorization':`Bearer ${sessionJWT}` } });
    if(!res.ok){ return false; }
    const data = await res.json();
    const fresh = hydrateFromAuthCheckPayload(data);
    if(!authedUser || (!authedUser.name && (!authedUser.email_addresses||!authedUser.email_addresses.length))){
      authedUser = fresh; localStorage.setItem('stytch_user', JSON.stringify(authedUser));
    } else {
      if (fresh.email_addresses?.[0]?.email_address && !authedUser.email_addresses?.length){ authedUser.email_addresses = fresh.email_addresses; }
      if ((fresh.name?.first_name||fresh.name?.last_name) && !(authedUser.name?.first_name||authedUser.name?.last_name)) authedUser.name = fresh.name;
      localStorage.setItem('stytch_user', JSON.stringify(authedUser));
    }
    updateAuthUI();
    return true;
  }catch(err){
    return !!authedUser;
  }
}

async function fetchWorkspaces(){
  try{
    const r = await fetch(apiUrl('workspaces'), { headers:{ 'Authorization':`Bearer ${sessionJWT}` } });
    if(!r.ok){ showBanner('Could not load workspaces.','red'); return []; }
    const data = await r.json().catch(()=>({workspaces:[]}));
    workspaces = data.workspaces||[];
    return workspaces;
  }catch(e){ showBanner('Network error loading workspaces.','red'); return []; }
}

function fillWorkspaceSelect(){
  const sel = document.getElementById('wsSelect');
  sel.innerHTML = '';
  if(!workspaces.length){
    const o = document.createElement('option'); o.text='No workspaces available'; sel.appendChild(o); sel.disabled = true; return;
  }
  sel.disabled = false;
  workspaces.forEach(w => {
    const o = document.createElement('option'); o.value = w.id; o.text = w.name || w.id; if(w.id === WORKSPACE_ID) o.selected = true; sel.appendChild(o);
  });
  sel.onchange = ()=>{ switchWorkspace(sel.value); };
}

async function switchWorkspace(id){
  if(!id) return;
  WORKSPACE_ID = id;
  const ws = workspaces.find(w=>w.id===id);
  WORKSPACE_NAME = ws ? ws.name : '';
  setQsParam('ws', id);
  localStorage.setItem('solara_last_ws', id);
  computeStorageNS();
  tabData = loadTabsFromStorage();
  if(Object.keys(tabData).length===0){ const def='Click to edit'; tabData[def] = { todo:[], inprogress:[], done:[] }; }
  activeTab = Object.keys(tabData)[0];
  await loadTabsFromCloud();
  updateWorkspaceCrumb();
  renderTabs();
  renderBoard();
}

function updateWorkspaceCrumb(){
  const el = document.getElementById('wsCrumb');
  el.textContent = WORKSPACE_NAME ? `${WORKSPACE_NAME} (${WORKSPACE_ID})` : (WORKSPACE_ID || '—');
}

/*******************
 *  MEMBERS (UI + API) *
 *******************/
function openMembers(){ document.getElementById('membersModal').classList.remove('hidden'); loadMembers(); }
function closeMembers(){ document.getElementById('membersModal').classList.add('hidden'); }

async function listShares(){
  if(!sessionJWT || !WORKSPACE_ID) return [];
  const url = apiUrl('shares') + `?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`;
  const res = await fetch(url, { headers:{ 'Authorization':`Bearer ${sessionJWT}` }});
  if(!res.ok) { console.warn('listShares failed', await res.text()); return []; }
  const data = await res.json();
  // Determine role of current user
  currentRole = 'owner';
  const me = (authedUser?.email_addresses?.[0]?.email_address||'').toLowerCase();
  const ownerRow = await fetch(apiUrl('workspaces') , { headers:{ 'Authorization':`Bearer ${sessionJWT}` }}).then(r=>r.ok?r.json():{workspaces:[]}).catch(()=>({workspaces:[]}));
  const thisWs = (ownerRow.workspaces||[]).find(w=>w.id===WORKSPACE_ID);
  if(thisWs && thisWs.owner_id){
    if (thisWs.owner_id !== (JSON.parse(localStorage.getItem('stytch_auth')||'{}').user_id||'__')) {
      const share = (data.shares||[]).find(s=> (s.email||'').toLowerCase()===me && s.accepted_by_user_id);
      if(share) currentRole = (share.role||'editor');
    }
  }
  return data.shares || [];
}
async function postShare(email){
  const res = await fetch(apiUrl('shares'), { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${sessionJWT}` }, body: JSON.stringify({ email, workspace_id: WORKSPACE_ID }) });
  return res;
}
async function resendShare(id){
  try{
    const r = await fetch(apiUrl(`shares/${id}/resend`), { method:'POST', headers:{ 'Authorization':`Bearer ${sessionJWT}` } });
    return r; // might be 404 on older worker
  }catch(e){ return { ok:false, status:0, text: async()=>String(e) }; }
}
async function patchShare(id, role){
  const res = await fetch(apiUrl(`shares/${id}`), { method:'PATCH', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${sessionJWT}` }, body: JSON.stringify({ role }) });
  return res;
}
async function deleteShare(id){
  const res = await fetch(apiUrl(`shares/${id}`), { method:'DELETE', headers:{ 'Authorization':`Bearer ${sessionJWT}` }});
  return res;
}

function renderShareRow(s){
  const row = document.createElement('div');
  row.className = 'flex items-center justify-between py-3';
  const who = document.createElement('div');
  who.className = 'flex items-center gap-3';
  const bubble = document.createElement('div');
  bubble.className = 'h-8 w-8 rounded-full bg-indigo-600/15 text-indigo-700 dark:text-indigo-300 flex items-center justify-center text-xs font-semibold';
  bubble.textContent = (s.email || '?').slice(0,2).toUpperCase();
  const meta = document.createElement('div');
  meta.innerHTML = `<div class="text-sm font-medium">${s.email || '—'}</div>
                    <div class="text-xs text-gray-500">${s.accepted_by_user_id ? 'Accepted' : 'Pending invite'} · invited ${new Date(s.invited_at||Date.now()).toLocaleDateString()}</div>`;
  who.appendChild(bubble); who.appendChild(meta);

  const actions = document.createElement('div');
  actions.className = 'flex items-center gap-2';
  const sel = document.createElement('select');
  sel.className = 'text-xs border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-800';
  ['editor','viewer'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.text=r; if(String(s.role||'editor')===r) o.selected=true; sel.appendChild(o); });
  sel.onchange = async ()=>{ const r = await patchShare(s.id, sel.value); if(!r.ok) alert('Failed to update role'); };

  const copyBtn = document.createElement('button');
  copyBtn.className = 'px-2 py-1 text-xs rounded bg-indigo-50 text-indigo-700 hover:bg-indigo-100';
  copyBtn.textContent = 'Copy link';
  copyBtn.onclick = async ()=>{
    const r = await resendShare(s.id);
    if(r.ok){
      const data = await r.json().catch(()=>({}));
      const link = data?.invite_link || null;
      if(link){ try{ await navigator.clipboard.writeText(link);}catch{} alert('Invite link copied to clipboard.'); }
      else alert('Resent invite. Check email.');
    } else if (r.status === 404) {
      alert('Server does not support Resend/copy for existing invites. Remove and re-invite to get a fresh link.');
    } else {
      const t = await r.text(); alert('Could not resend: ' + t);
    }
  };

  const del = document.createElement('button');
  del.className = 'px-2 py-1 text-xs rounded bg-red-50 text-red-600 hover:bg-red-100';
  del.textContent = 'Remove';
  del.onclick = async ()=>{ if(!confirm('Remove this member?')) return; const r = await deleteShare(s.id); if(r.ok) loadMembers(); else alert('Failed to remove'); };

  actions.appendChild(sel);
  actions.appendChild(copyBtn);
  actions.appendChild(del);
  row.appendChild(who); row.appendChild(actions);
  return row;
}

async function loadMembers(){
  const list = document.getElementById('membersList');
  list.innerHTML = '<div class="py-6 text-sm text-gray-500">Loading…</div>';
  const shares = await listShares();
  if(!shares.length){ list.innerHTML = '<div class="py-6 text-sm text-gray-500">No members yet. Invite someone above.</div>'; return; }
  list.innerHTML = '';
  shares.forEach(s => list.appendChild(renderShareRow(s)));
}

async function inviteMember(){
  const input = document.getElementById('inviteEmail');
  const email = (input.value||'').trim().toLowerCase();
  if(!email) return;
  if(!WORKSPACE_ID){ alert('No workspace selected.'); return; }
  const r = await postShare(email);
  let body = null;
  try{ body = await r.json(); }catch{ body = null; }
  if(r.ok){
    input.value=''; await loadMembers();
    const link = body?.invite_link || null;
    if(link){ try{ await navigator.clipboard.writeText(link);}catch{} alert(`Invitation created. Invite link copied to clipboard.\n\n${link}\n\n(Email also sent—check Spam/Promotions if needed.)`); }
    else { alert('Invitation created. (Email sent)'); }
  }
  else {
    const link = body?.invite_link || null;
    const err = body?.error || await r.text();
    if(link){ try{ await navigator.clipboard.writeText(link);}catch{} alert(`Invite email failed (${err}). Invite link copied:\n\n${link}`); }
    else { alert('Invite failed: ' + err); }
  }
}

/*******************
 *  TABS            *
 *******************/
function renderTabs(){
  const tabsContainer = document.getElementById('tabs');
  tabsContainer.innerHTML = '';
  const names = Object.keys(tabData);
  names.forEach(name => {
    const tabBtn = document.createElement('button');
    tabBtn.className = `tab-button px-4 py-1.5 rounded-full text-sm font-medium bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-white transition-all duration-150 truncate max-w-[160px]`;
    if (name === activeTab){ tabBtn.classList.add('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30'); }
    tabBtn.dataset.tab = name;
    tabBtn.innerHTML = `<span>${name}</span>`;
    tabBtn.onclick = () => switchTab(name);
    tabBtn.ondblclick = () => {
      const newName = prompt('Rename tab:', name);
      if (!newName || !newName.trim() || newName === name || tabData[newName]) return;
      tabData[newName] = tabData[name];
      delete tabData[name];
      if (activeTab === name) activeTab = newName;
      saveTabsToStorage();
      renderTabs();
      switchTab(activeTab);
      saveTabsToCloud();
    };
    tabBtn.oncontextmenu = (e) => { e.preventDefault(); deleteTab(name); };
    tabsContainer.appendChild(tabBtn);
  });
}
function promptNewTab(){ const name = prompt('Enter tab name:'); if(!name || !name.trim()) return; addTab(name.trim()); }
function addTab(name){ if(tabData[name]) return switchTab(name); tabData[name] = { todo:[], inprogress:[], done:[] }; saveTabsToStorage(); renderTabs(); switchTab(name); saveTabsToCloud(); }
function deleteTab(name){ if(!confirm(`Delete tab "${name}" and all its tasks?`)) return; delete tabData[name]; if(activeTab===name) activeTab = Object.keys(tabData)[0]||null; saveTabsToStorage(); renderTabs(); renderBoard(); saveTabsToCloud(); }

/*******************
 *  BOARD LOGIC     *
 *******************/
function switchTab(tabName){ if(!tabData[tabName]) return; activeTab = tabName; document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30')); const activeBtn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.dataset.tab===tabName); if(activeBtn){ activeBtn.classList.add('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30'); } renderBoard(); }

function ensureAtLeastOneTask(){ const cols = tabData[activeTab]; if(!cols) return; if((cols.todo?.length||0)+(cols.inprogress?.length||0)+(cols.done?.length||0)===0){ const id = `task-${Date.now()}-${Math.random().toString(36).slice(2,6)}`; cols.todo.push({ id, content:'', dueDate:'', priority:'Medium' }); } }

function renderBoard(){
  const columns = ['todo','inprogress','done'];
  columns.forEach(col => {
    const colEl = document.getElementById(col);
    colEl.querySelectorAll('[data-task]')?.forEach(n => n.remove());

    colEl.ondragover = (e)=>{
      e.preventDefault();
      colEl.classList.add('drag-over','show-drop');
      const after = getDragAfterElement(colEl, e.clientY);
      const indicator = colEl.querySelector('.drop-indicator');
      if(after == null){ colEl.appendChild(indicator); } else { colEl.insertBefore(indicator, after); }
      dragContext.overCol = colEl.dataset.col;
      dragContext.insertIndex = computeInsertIndex(colEl, indicator);
    };
    colEl.ondragleave = ()=>{ colEl.classList.remove('drag-over','show-drop'); };
    colEl.ondrop = (e)=>{
      e.preventDefault();
      colEl.classList.remove('drag-over','show-drop');
      const id = dragContext.id;
      if(!id) return;
      commitReorder(id, dragContext.fromCol, colEl.dataset.col, dragContext.insertIndex);
      clearDragContext();
    };
  });
  if(!activeTab || !tabData[activeTab]) return;
  ensureAtLeastOneTask();
  const data = tabData[activeTab];
  ['todo','inprogress','done'].forEach(col => {
    const colEl = document.getElementById(col);
    (data[col]||[]).forEach(t => { colEl.appendChild(createTaskElement(t.id, t.content, t.dueDate, t.priority, col)); });
  });
}

function createTaskElement(id, content='', dueDate='', priority='Medium', column){
  const wrapper = document.createElement('div');
  wrapper.id = id; wrapper.setAttribute('data-task','1'); wrapper.draggable = true; wrapper.className = 'relative p-3 rounded bg-white dark:bg-gray-700 shadow cursor-move mb-2'; wrapper.setAttribute('data-column', column);

  const editable = document.createElement('div'); editable.className = 'editable w-full font-medium mb-1'; editable.contentEditable = currentRole !== 'viewer'; editable.innerText = content;
  const placeholder = document.createElement('span'); placeholder.className = 'absolute left-3 top-3 text-sm text-gray-400 pointer-events-none'; placeholder.textContent = 'Click to edit...';
  function togglePlaceholder(){ placeholder.style.display = editable.innerText.trim()==='' ? 'block' : 'none'; }

  const row = document.createElement('div'); row.className = 'flex items-center gap-2';
  const dateInput = document.createElement('input'); dateInput.type = 'date'; dateInput.value = normalizeDateString(dueDate) || ''; dateInput.disabled = (currentRole==='viewer'); dateInput.className = 'mt-1 text-xs bg-transparent text-gray-700 dark:text-gray-200 border border-transparent rounded px-1 date-badge';
  const prioritySelect = document.createElement('select'); prioritySelect.disabled = (currentRole==='viewer'); prioritySelect.className = 'mt-1 ml-2 text-xs bg-transparent text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded px-1'; ['High','Medium','Low'].forEach(level=>{ const opt=document.createElement('option'); opt.value=level; opt.text=level; if(level===priority) opt.selected=true; prioritySelect.appendChild(opt); });
  const deleteBtn = document.createElement('button'); deleteBtn.className = 'absolute top-2 right-2 text-gray-400 hover:text-red-500'; deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'; deleteBtn.title = 'Delete Task'; deleteBtn.onclick = () => { if(confirm('Delete this task?')) removeTaskById(id); };
  if(currentRole==='viewer') deleteBtn.disabled = true;

  wrapper.addEventListener('dragstart', e => {
    if(currentRole==='viewer'){ e.preventDefault(); return; }
    wrapper.classList.add('dragging');
    e.dataTransfer.setData('text/plain', id);
    dragContext.id = id;
    dragContext.fromCol = wrapper.getAttribute('data-column');
  });
  wrapper.addEventListener('dragend', () => { wrapper.classList.remove('dragging'); });

  editable.addEventListener('input', ()=>{ togglePlaceholder(); persistTaskEdits(id, { content: editable.innerText.trim() }); });
  editable.addEventListener('blur', ()=> persistTaskEdits(id, { content: editable.innerText.trim() }));
  dateInput.addEventListener('change', ()=> persistTaskEdits(id, { dueDate: normalizeDateString(dateInput.value) }));
  prioritySelect.addEventListener('change', ()=> persistTaskEdits(id, { priority: prioritySelect.value || 'Medium' }));

  row.appendChild(dateInput); row.appendChild(prioritySelect);
  wrapper.appendChild(editable); wrapper.appendChild(placeholder); wrapper.appendChild(row); wrapper.appendChild(deleteBtn);
  togglePlaceholder();
  return wrapper;
}

// ---- Precise reorder helpers ----
function clearDragContext(){ dragContext = { id:null, fromCol:null, overCol:null, insertIndex:null }; }
function getDragAfterElement(container, y){
  const draggableElements = [...container.querySelectorAll('[data-task]:not(.dragging)')];
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}
function computeInsertIndex(colEl, indicator){
  const siblings = [...colEl.querySelectorAll('[data-task]')];
  if (siblings.length === 0) return 0;
  const all = [...colEl.children];
  let index = 0;
  for (let i=0; i<all.length; i++){
    const el = all[i];
    if(el === indicator){
      index = [...all.slice(0,i)].filter(n => n.hasAttribute && n.hasAttribute('data-task')).length;
      return index;
    }
  }
  return siblings.length;
}
function commitReorder(taskId, fromCol, toCol, insertIndex){
  if(!activeTab || !tabData[activeTab]) return;
  if(currentRole==='viewer') return;
  const cols = tabData[activeTab];
  let moved; const fromList = cols[fromCol]||[]; const i = fromList.findIndex(t=>t.id===taskId);
  if(i !== -1){ moved = fromList.splice(i,1)[0]; }
  if(!moved) return;
  const target = cols[toCol] = cols[toCol]||[];
  if(insertIndex == null || insertIndex < 0) insertIndex = target.length;
  if(insertIndex > target.length) insertIndex = target.length;
  target.splice(insertIndex, 0, moved);
  saveTabsToStorage();
  renderBoard();
  saveTabsToCloud();
}

function persistTaskEdits(taskId, patch){
  if(!activeTab || !tabData[activeTab]) return;
  if(currentRole==='viewer') return;
  const cols = ['todo','inprogress','done'];
  for(const col of cols){ const list = tabData[activeTab][col]||[]; const idx = list.findIndex(t=>t.id===taskId); if(idx!==-1){
      if('dueDate' in patch) patch.dueDate = normalizeDateString(patch.dueDate);
      Object.assign(list[idx], patch); break; } }
  saveTabsToStorage(); saveTabsToCloud();
}
function removeTaskById(taskId){
  if(!activeTab || !tabData[activeTab]) return;
  if(currentRole==='viewer') return;
  const cols = ['todo','inprogress','done'];
  for(const col of cols){ const list = tabData[activeTab][col]||[]; const idx = list.findIndex(t=>t.id===taskId); if(idx!==-1){ list.splice(idx,1); break; } }
  saveTabsToStorage(); renderBoard(); saveTabsToCloud();
}
function clearAllTasks(){ if(!activeTab) return; if(currentRole==='viewer') return; if(!confirm('Clear all tasks in this tab?')) return; tabData[activeTab] = { todo:[], inprogress:[], done:[] }; saveTabsToStorage(); renderBoard(); saveTabsToCloud(); }
function addNewTask(){ if(currentRole==='viewer') return; if(!activeTab){ const def='Click to edit'; if(!tabData[def]) tabData[def]={ todo:[], inprogress:[], done:[] }; activeTab=def; renderTabs(); }
  const id = `task-${Date.now()}-${Math.random().toString(36).slice(2,6)}`; const t = { id, content:'', dueDate:'', priority:'Medium' }; tabData[activeTab].todo.push(t); saveTabsToStorage(); renderBoard(); saveTabsToCloud(); }

/*******************
 *  EXPORT & REPORTS *
 *******************/
function exportBoardAsPDF(){ const board = document.getElementById('board'); html2pdf().set({ margin:.5, filename:`Solara-Board-${WORKSPACE_NAME||WORKSPACE_ID||'Untitled'}.pdf`, image:{type:'jpeg',quality:.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'letter', orientation:'landscape'} }).from(board).save(); }
function openReports(){ const ws = WORKSPACE_ID || localStorage.getItem('solara_last_ws') || ''; const u = new URL(location.origin + '/reports.html'); if(ws) u.searchParams.set('ws', ws); location.href = u.toString(); }

/*******************
 *  POLLING          *
 *******************/
async function pollCloud(){
  if(!sessionJWT || !WORKSPACE_ID) return;
  const before = JSON.stringify(tabData);
  const ok = await loadTabsFromCloud();
  if(ok){ const after = JSON.stringify(tabData); if (before !== after) { renderTabs(); renderBoard(); } }
}

/*******************
 *  BOOT             *
 *******************/
window.addEventListener('pagehide', () => { try { saveTabsToStorage(); } catch {} flushCloudNow(); if(pollTimer) clearInterval(pollTimer); });

document.addEventListener('DOMContentLoaded', async () => {
  hideBanner();
  const ok = await verifySessionAndHydrate();
  if(!ok) return requireReauth();
  wireAuthButtons();

  // Workspaces
  await fetchWorkspaces();
  const wsFromUrl = qsParam('ws');
  const wsFromStorage = localStorage.getItem('solara_last_ws');
  let target = null;
  if(wsFromUrl && workspaces.find(w=>w.id===wsFromUrl)) target = wsFromUrl;
  else if(wsFromUrl && !workspaces.find(w=>w.id===wsFromUrl)) { showBanner('You do not have access to this workspace id; showing your first workspace instead.','red'); }
  if(!target) target = (workspaces[0]?.id) || wsFromStorage || '';
  if(!target){ showBanner('No workspaces available. Ask an owner to invite you, or create one in the Workspaces page.'); }

  // Set and render
  if(target){ WORKSPACE_ID = target; WORKSPACE_NAME = (workspaces.find(w=>w.id===target)||{}).name||''; setQsParam('ws', target); localStorage.setItem('solara_last_ws', target); }
  computeStorageNS();
  migrateLegacyIfNeeded();

  // Local cache first for quick paint
  tabData = loadTabsFromStorage();
  if(Object.keys(tabData).length===0){ const def='Click to edit'; tabData[def] = { todo:[], inprogress:[], done:[] }; }
  activeTab = Object.keys(tabData)[0];
  fillWorkspaceSelect();
  updateWorkspaceCrumb();
  renderTabs();
  renderBoard();

  // Cloud load & start polling
  const loaded = await loadTabsFromCloud();
  if(loaded){ if(!tabData[activeTab]) activeTab = Object.keys(tabData)[0]||activeTab; renderTabs(); renderBoard(); }
  pollTimer = setInterval(pollCloud, POLL_MS);

  // Buttons
  document.getElementById('reloadBtn').onclick = async ()=>{ hideBanner(); await loadTabsFromCloud(); renderTabs(); renderBoard(); };
  const btn = document.getElementById('manageBtn');
  if(btn){ btn.addEventListener('click', ()=>{ if(!WORKSPACE_ID) return alert('Open a workspace to manage members.'); openMembers(); }); }
});
</script>
</body>
</html>
