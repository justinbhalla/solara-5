<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Solara â€“ Adaptive Workspace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    .drag-over{ background:rgba(99,102,241,.08); outline:2px dashed #6366f1; outline-offset:-2px }
    .menu-card{ box-shadow:0 10px 20px rgba(0,0,0,.08) }
    .editable{ outline:none; min-height:1.5rem }
    .dragging{ opacity:.6; transform:rotate(.4deg) }
    .drop-indicator{ height:.5rem; border-radius:.25rem; background:rgba(99,102,241,.45); margin:.25rem 0; display:none }
    .show-drop .drop-indicator{ display:block }
    .date-badge{ font-variant-numeric: tabular-nums }
    .presence-dot{ position:absolute; right:-2px; bottom:-2px; width:10px; height:10px; border-radius:999px; background:#10b981; border:2px solid white }
    .avatar{ position:relative }
    .typing-pill{ font-size:10px; padding:2px 6px; border-radius:999px; background:rgba(99,102,241,.1); color:#4f46e5; margin-top:.25rem; display:inline-block }
    footer .slot{ min-width:0 }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100">

<div id="wsBanner" class="hidden bg-amber-50 text-amber-900 border-b border-amber-200 px-6 py-2 text-sm">
  No workspace selected. <a class="underline font-medium" href="workspace.html">Go to Workspaces</a>
</div>

<header class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
  <div class="flex items-center gap-3">
    <a id="workspacesLink" href="workspace.html" class="w-9 h-9 rounded-xl bg-indigo-600/10 text-indigo-600 flex items-center justify-center hover:bg-indigo-600/20" title="Back to Workspaces">ðŸ”·</a>
    <div>
      <h1 class="text-3xl font-bold tracking-tight">Solara</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400">Part of the ZLG Product Suite</p>
    </div>
  </div>

  <div class="flex items-center gap-4">
    <div class="relative">
      <button id="presenceBtn" class="flex -space-x-2 items-center">
        <span id="presenceAvatars" class="flex -space-x-2"></span>
        <span id="presenceCount" class="ml-2 text-xs text-gray-500"></span>
      </button>
      <div id="presenceTooltip" class="hidden absolute right-0 mt-2 w-64 rounded-xl menu-card bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 p-3 text-sm shadow">
        <div class="font-semibold mb-2">Online now</div>
        <div id="presenceList" class="space-y-1 max-h-56 overflow-auto"></div>
      </div>
    </div>

    <div id="userArea" class="relative">
      <button id="userButton" class="flex items-center gap-2 px-3 py-2 rounded-full border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
        <span id="avatar" class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-indigo-600 text-white text-xs font-semibold">?</span>
        <span id="userName" class="text-sm font-medium">User</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/></svg>
      </button>
      <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 rounded-xl menu-card bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 overflow-hidden">
        <div class="px-4 py-3 text-sm">
          <div id="userEmail" class="text-gray-600 dark:text-gray-300"></div>
        </div>
        <div class="border-t border-gray-100 dark:border-gray-700"></div>
        <button id="addUserBtn" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700">Add userâ€¦</button>
        <button id="signOutBtn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">Sign out</button>
      </div>
    </div>
  </div>
</header>

<nav class="flex items-center justify-between px-6 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm font-medium">
  <div class="flex items-center gap-6">
    <button class="flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-semibold">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3h14v2H3V3zm0 4h9v2H3V7zm0 4h14v2H3v-2zm0 4h9v2H3v-2z"/></svg>
      <span>Tasks</span>
    </button>
    <button id="reportsLink" class="flex items-center gap-2 text-gray-700 dark:text-gray-200 hover:text-indigo-600">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M7 16v-4m4 4V8m4 8V5"/></svg>
      <span>Reports</span>
    </button>
  </div>
  <div class="flex items-center gap-3">
    <button id="clearBtn" title="Clear all tasks in current tab" class="p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition-all">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m0 0A2.99 2.99 0 017 6h10a2.99 2.99 0 012.418 3H19v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9h.582zM10 11v6m4-6v6"/></svg>
    </button>
    <button id="newTaskBtn" class="px-4 py-1.5 text-sm rounded bg-indigo-600 text-white hover:bg-indigo-500 shadow transition">+</button>
  </div>
</nav>

<main class="p-6 flex-1 overflow-y-auto">
  <div id="board" class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div id="todo" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="todo">
      <h2 class="text-lg font-semibold mb-2">To Do</h2><div class="drop-indicator"></div>
    </div>
    <div id="inprogress" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="inprogress">
      <h2 class="text-lg font-semibold mb-2">In Progress</h2><div class="drop-indicator"></div>
    </div>
    <div id="done" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="done">
      <h2 class="text-lg font-semibold mb-2">Done</h2><div class="drop-indicator"></div>
    </div>
  </div>
</main>

<div class="sticky bottom-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 z-50">
  <div class="flex items-center justify-between px-6 py-3 overflow-x-auto">
    <div class="flex items-center gap-2 w-full overflow-x-auto px-1 py-1">
      <div id="tabs" class="flex gap-2 min-w-max"></div>
      <button id="addTabBtn" title="Add Tab" class="p-2 rounded-full bg-green-100 hover:bg-green-200 text-green-700 transition duration-150 shadow-sm border border-green-200">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
      </button>
    </div>
    <div class="flex items-center gap-1">
      <button id="manageBtn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition" title="Manage members">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.57-.906 3.435.96 2.53 2.53a1.724 1.724 0 001.065 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.906 1.57-.96 3.435-2.53 2.53a1.724 1.724 0 00-2.573 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.57.906-3.435-.96-2.53-2.53A1.724 1.724 0 003.087 13.9c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.906-1.57.96-3.435 2.53-2.53.98.565 2.229.11 2.642-1.13zM12 9a3 3 0 110 6 3 3 0 010-6z"/></svg>
      </button>
      <button id="exportBtn" class="ml-1 p-2 rounded-full hover:bg-indigo-100 text-indigo-600 transition" title="Download Board">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm-7 4h14v-2H5v2z"/></svg>
      </button>
    </div>
  </div>
  <footer class="grid grid-cols-3 items-center text-center text-xs text-gray-500 dark:text-gray-400 px-6 py-3 border-t border-gray-200 dark:border-gray-700">
    <div class="slot text-left truncate">Workspace: <span id="wsName">â€”</span></div>
    <div class="slot">Â© 2025 ZenLock Group (ZLG). All rights reserved.</div>
    <div class="slot text-right truncate"><span id="lastSynced">Last synced: â€”</span></div>
  </footer>
</div>

<div id="membersModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
  <div class="absolute inset-0 bg-black/40" onclick="closeMembers()"></div>
  <div class="relative w-full max-w-lg rounded-2xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 p-5 shadow-xl">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">Workspace Members</h3>
      <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800" onclick="closeMembers()" title="Close">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="flex gap-2 mb-3">
      <input id="inviteEmail" type="email" placeholder="name@example.com" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm"/>
      <button id="inviteBtn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 text-sm">Invite</button>
    </div>
    <div id="membersList" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
  </div>
</div>

<script>
const API_BASE = "https://shy-smoke-ab8e.justinbhalla28.workers.dev";
const apiUrl = p => API_BASE.replace(/\/+$/,'') + '/' + String(p||'').replace(/^\/+/,'');

let WORKSPACE_ID = '';
let WORKSPACE_NAME = '';
let sessionJWT = null;
let authedUser = null;
let currentUserKey = null;
let currentRole = 'viewer';

const COLS = ['todo','inprogress','done'];
let activeTab = null;
let tabData = {};
let ws = null;
let presence = new Map();
let typing = new Map();
let lastSyncedAt = null;

const debounce = (fn, ms=200)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
const persistHTTP = debounce(()=> saveTabsHTTP(tabData).catch(()=>{}), 800);

function getSessionJWT(){
  const m = document.cookie.match(/(?:^|; )(?:stytch_session_jwt|solara_session_jwt)=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : (localStorage.getItem('stytch_session_jwt') || localStorage.getItem('solara_session_jwt') || null);
}
function initials(name,email){ const parts=(name||'').trim().split(/\s+/).filter(Boolean); return parts.length?parts.slice(0,2).map(s=>s[0]).join('').toUpperCase():(email||'?').slice(0,2).toUpperCase(); }
function normalizeDateString(v){ if(!v) return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; const d=new Date(v); if(isNaN(d)) return ''; const tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().slice(0,10); }
function stampSync(){ lastSyncedAt = new Date(); document.getElementById('lastSynced').textContent = 'Last synced: ' + lastSyncedAt.toLocaleTimeString(); }
function displayNameFor(u){ const f=u?.name?.first_name, l=u?.name?.last_name, e=u?.email_addresses?.[0]?.email_address; return [f,l].filter(Boolean).join(' ') || e || 'User'; }
function cryptoRandom(){ try{ return crypto.randomUUID(); }catch{ return Math.random().toString(36).slice(2); } }

async function verifySessionAndHydrate(){
  sessionJWT = getSessionJWT();
  if(!sessionJWT) return false;
  try{
    const r = await fetch(apiUrl('auth/check'), { headers:{ 'Authorization':`Bearer ${sessionJWT}` }});
    if(!r.ok) return false;
    const data = await r.json();
    currentUserKey = data.user_id;
    const email = data.email ? [{ email_address: data.email }] : [];
    const parts = (data.name||'').split(/\s+/);
    authedUser = { name:{ first_name:parts[0]||'', last_name:parts.slice(1).join(' ')||'' }, email_addresses: email };
    localStorage.setItem('stytch_user', JSON.stringify(authedUser));
    updateAuthUI();
    return true;
  }catch{ return false; }
}
function updateAuthUI(){
  const name=displayNameFor(authedUser);
  const email=authedUser?.email_addresses?.[0]?.email_address||'';
  document.getElementById('avatar').textContent = initials(name,email);
  document.getElementById('userName').textContent = name;
  document.getElementById('userEmail').textContent = email;
}

async function fetchRole(){ const r=await fetch(apiUrl(`workspaces/${encodeURIComponent(WORKSPACE_ID)}/role`), { headers:{ 'Authorization':`Bearer ${sessionJWT}` }}); if(!r.ok) return 'viewer'; const j=await r.json().catch(()=>({})); return j.role||'viewer'; }
async function listShares(){ const r=await fetch(apiUrl(`shares?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`), { headers:{ 'Authorization':`Bearer ${sessionJWT}` }}); if(!r.ok) return []; const j=await r.json().catch(()=>({shares:[]})); return j.shares||[]; }
async function invite(email){ return fetch(apiUrl('shares'), { method:'POST', headers:{'Authorization':`Bearer ${sessionJWT}`,'Content-Type':'application/json'}, body: JSON.stringify({ workspace_id: WORKSPACE_ID, email }) }); }
async function patchShareRole(id, role){ return fetch(apiUrl(`shares/${id}`), { method:'PATCH', headers:{'Authorization':`Bearer ${sessionJWT}`,'Content-Type':'application/json'}, body: JSON.stringify({ role }) }); }
async function removeShare(id){ return fetch(apiUrl(`shares/${id}`), { method:'DELETE', headers:{'Authorization':`Bearer ${sessionJWT}`}}); }
async function transferOwner(toEmail){ return fetch(apiUrl(`workspaces/${encodeURIComponent(WORKSPACE_ID)}/transfer_owner`), { method:'POST', headers:{'Authorization':`Bearer ${sessionJWT}`,'Content-Type':'application/json'}, body: JSON.stringify({ to_email: toEmail }) }); }

async function fetchTabs(){ const r=await fetch(apiUrl(`tasks?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`), { headers:{ 'Authorization':`Bearer ${sessionJWT}` }}); if(!r.ok) return {}; const j=await r.json().catch(()=>({tabs:{}})); return j.tabs||{}; }
async function saveTabsHTTP(tabs){ await fetch(apiUrl('tasks'), { method:'POST', headers:{'Authorization':`Bearer ${sessionJWT}`,'Content-Type':'application/json'}, body: JSON.stringify({ workspace_id: WORKSPACE_ID, tabs }) }); }

function liveUrl(){ try{ const u=new URL(API_BASE); u.pathname=(u.pathname.replace(/\/+$/,'')+'/live').replace(/\/{2,}/g,'/'); u.search=`?ws=${encodeURIComponent(WORKSPACE_ID)}&token=${encodeURIComponent(sessionJWT)}`; u.protocol=u.protocol.replace('http','ws'); return u.toString(); }catch{ return null; } }
function liveSend(obj){ if(ws && ws.readyState===1){ try{ ws.send(JSON.stringify({ ...obj, ws: WORKSPACE_ID })); }catch{} } }

function connectLive(){
  const url = liveUrl(); if(!url) return;
  ws = new WebSocket(url);
  ws.onmessage = (ev)=>{
    let msg = {}; try{ msg=JSON.parse(ev.data||'{}'); }catch{}
    if(msg.type==='hello'){
      currentUserKey = msg.you?.user_id || currentUserKey;
      presence.clear();
      (msg.online||[]).forEach(p=> presence.set(p.id, { name:p.name, email:p.email }));
      renderPresence();

      tabData = migrateShapes(msg.tabs||{});
      if(Object.keys(tabData).length===0){ tabData['Click to edit']={ todo:[], inprogress:[], done:[] }; }
      if(!activeTab) activeTab = Object.keys(tabData)[0];
      renderTabs(); switchTab(activeTab);
      stampSync();
      return;
    }

    if(msg.type==='op' && msg.by !== currentUserKey && msg.ws===WORKSPACE_ID){
      applyOpLocal(tabData, msg.op);  // âœ… local+DOM surgical patch
      stampSync();
      return;
    }

    if(msg.type==='tabs:set' && msg.ws===WORKSPACE_ID){
      mergeSnapshotIntoLocal(msg.tabs||{});
      stampSync();
      return;
    }

    if (msg.type === 'presence/typing' && msg.ws===WORKSPACE_ID) {
      registerTyping(msg.by, msg.taskId, msg.at, msg.name);
      return;
    }

    if(msg.type==='presence/join'){ if(msg.by && msg.by!==currentUserKey){ presence.set(msg.by, { name:msg.name||'', email:msg.email||'' }); renderPresence(); } return; }
    if(msg.type==='presence/leave'){ presence.delete(msg.by); renderPresence(); return; }
  };
}

function renderPresence(){
  const avatars=document.getElementById('presenceAvatars');
  const list=document.getElementById('presenceList');
  const count=document.getElementById('presenceCount');
  avatars.innerHTML=''; list.innerHTML='';

  const others = [...presence.entries()].map(([id,v])=>({id,...v})).sort((a,b)=>(a.name||a.email).localeCompare(b.name||b.email));
  count.textContent = others.length ? '' : '0 online';

  const max=4;
  others.slice(0,max).forEach(p=>{
    const span=document.createElement('span');
    span.className='avatar inline-flex items-center justify-center h-7 w-7 rounded-full bg-indigo-600/10 text-indigo-700 dark:text-indigo-300 text-[11px] font-semibold ring-2 ring-white';
    span.title=p.name||p.email; span.textContent=initials(p.name,p.email);
    const dot=document.createElement('span'); dot.className='presence-dot'; span.appendChild(dot);
    avatars.appendChild(span);

    const row=document.createElement('div');
    row.className='flex items-center gap-2';
    row.innerHTML=`<div class="relative inline-flex items-center justify-center h-6 w-6 rounded-full bg-indigo-600/10 text-indigo-700 dark:text-indigo-300 text-[10px] font-semibold">
      ${initials(p.name,p.email)}<span class="presence-dot" style="right:-1px;bottom:-1px;width:8px;height:8px"></span></div>
      <div class="truncate">${p.name||p.email}</div>`;
    list.appendChild(row);
  });
  if(others.length>max){
    const extra=others.length-max;
    const more=document.createElement('span');
    more.className='avatar inline-flex items-center justify-center h-7 w-7 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 text-[11px] font-semibold ring-2 ring-white';
    more.textContent = `+${extra}`; avatars.appendChild(more);
  }
}
document.getElementById('presenceBtn').onclick = ()=> document.getElementById('presenceTooltip').classList.toggle('hidden');

function registerTyping(userId, taskId, at, name=''){
  if(!taskId || !userId || userId===currentUserKey) return;
  if (!typing.has(taskId)) typing.set(taskId, new Map());
  typing.get(taskId).set(userId, { name, at });
  paintTyping(taskId);
  setTimeout(()=>{ const m=typing.get(taskId); if(!m) return; const v=m.get(userId); if(!v) return; if(Date.now()-v.at>3500){ m.delete(userId); paintTyping(taskId); } }, 3600);
}
function paintTyping(taskId){
  const el = document.querySelector(`[data-task-id="${taskId}"] .typing-area`);
  if(!el) return;
  const m = typing.get(taskId);
  el.innerHTML = '';
  if(!m || m.size===0) return;
  [...m.values()].slice(0,3).forEach(v=>{
    const pill=document.createElement('span'); pill.className='typing-pill'; pill.textContent=`${v.name||'Someone'} is typingâ€¦`;
    el.appendChild(pill);
  });
}

function migrateShapes(data){
  const out=JSON.parse(JSON.stringify(data||{}));
  Object.keys(out).forEach(tab=>{
    COLS.forEach(col=>{
      let pos=1;
      out[tab][col]=(out[tab][col]||[]).map(t=>({
        id: t.id||`task-${cryptoRandom()}`,
        content: typeof t.content==='string'?t.content:'',
        dueDate: normalizeDateString(t.dueDate),
        priority: ['High','Medium','Low'].includes(t.priority)?t.priority:'Medium',
        pos: Number.isFinite(+t.pos)?+t.pos:pos++,
        upd: Number.isFinite(+t.upd)?+t.upd:Date.now(),
        by: t.by||currentUserKey||'unknown'
      }));
    });
  });
  return out;
}

function renderTabs(){
  const node=document.getElementById('tabs'); node.innerHTML='';
  const names=Object.keys(tabData);
  names.forEach(name=>{
    const b=document.createElement('button');
    b.className='tab-button px-4 py-1.5 rounded-full text-sm font-medium bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-white transition-all duration-150 truncate max-w-[160px]';
    if(name===activeTab){ b.classList.add('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30'); }
    b.dataset.tab=name; b.textContent=name;
    b.onclick=()=>{ switchTab(name); };
    b.ondblclick=()=>{ if(currentRole==='viewer') return; const nn=prompt('Rename tab:',name); const to=(nn||'').trim(); if(!to||to===name||tabData[to])return;
      tabData[to]=tabData[name]; delete tabData[name]; if(activeTab===name) activeTab=to; renderTabs(); switchTab(activeTab);
      liveSend({ type:'op', op:{ kind:'tab/rename', from:name, to } }); persistHTTP(); stampSync();
    };
    b.oncontextmenu=(e)=>{ e.preventDefault(); if(currentRole==='viewer')return; if(!confirm(`Delete tab "${name}"?`)) return;
      delete tabData[name]; if(activeTab===name) activeTab=Object.keys(tabData)[0]||null; renderTabs(); renderBoard();
      liveSend({ type:'op', op:{ kind:'tab/delete', name } }); persistHTTP(); stampSync();
    };
    node.appendChild(b);
  });
}

function switchTab(tab){ if(!tabData[tab]) return; activeTab=tab;
  document.querySelectorAll('.tab-button').forEach(x=>x.classList.remove('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30'));
  const btn=[...document.querySelectorAll('.tab-button')].find(b=>b.dataset.tab===tab); if(btn) btn.classList.add('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30');
  renderBoard();
}

function ensureAtLeastOne(){ const cols=tabData[activeTab]; if(!cols) return; if((cols.todo?.length||0)+(cols.inprogress?.length||0)+(cols.done?.length||0)===0){ const id=`task-${cryptoRandom()}`; cols.todo.push({ id, content:'', dueDate:'', priority:'Medium', pos:1, upd:Date.now(), by: currentUserKey }); } }

function renderBoard(){
  COLS.forEach(col=>{
    const colEl=document.getElementById(col);
    colEl.querySelectorAll('.card')?.forEach(n=>n.remove());

    colEl.ondragover = (e)=>{
      e.preventDefault(); colEl.classList.add('drag-over','show-drop');
      const after=getAfter(colEl, e.clientY);
      const indicator=colEl.querySelector('.drop-indicator');
      if(after==null){ colEl.appendChild(indicator); } else { colEl.insertBefore(indicator, after); }
      dragContext.overCol = colEl.dataset.col;
      dragContext.insertIndex = computeInsertIndex(colEl, indicator);
    };
    colEl.ondragleave = ()=>{ colEl.classList.remove('drag-over','show-drop'); };
    colEl.ondrop = (e)=>{
      e.preventDefault(); colEl.classList.remove('drag-over','show-drop');
      const id=dragContext.id; if(!id) return;
      moveTaskDomAndModel(id, dragContext.fromCol, colEl.dataset.col, dragContext.insertIndex, true);
      clearDrag();
    };
  });

  if(!activeTab || !tabData[activeTab]) return;
  ensureAtLeastOne();
  const data=tabData[activeTab];
  COLS.forEach(col=>{
    const colEl=document.getElementById(col);
    (data[col]||[]).sort((a,b)=> (a.pos||0)-(b.pos||0)).forEach(t=> colEl.appendChild(createTaskCard(t, col)));
  });
}

function createTaskCard(t, column){
  const wrapper = document.createElement('div');
  wrapper.className = 'card relative p-3 rounded bg-white dark:bg-gray-700 shadow cursor-move mb-2';
  wrapper.setAttribute('data-column', column);
  wrapper.setAttribute('data-task-id', t.id);
  wrapper.draggable = currentRole!=='viewer';

  const editable = document.createElement('div');
  editable.className = 'editable w-full font-medium mb-1';
  editable.contentEditable = (currentRole!=='viewer');
  editable.innerText = t.content || '';
  const placeholder = document.createElement('span');
  placeholder.className = 'absolute left-3 top-3 text-sm text-gray-400 pointer-events-none';
  placeholder.textContent = 'Click to edit...';

  const row = document.createElement('div'); row.className='flex items-center gap-2';
  const dateInput = document.createElement('input'); dateInput.type='date'; dateInput.value=normalizeDateString(t.dueDate)||''; dateInput.disabled=(currentRole==='viewer'); dateInput.className='mt-1 text-xs bg-transparent text-gray-700 dark:text-gray-200 border border-transparent rounded px-1 date-badge';
  const prioritySelect=document.createElement('select'); prioritySelect.disabled=(currentRole==='viewer'); prioritySelect.className='mt-1 ml-2 text-xs bg-transparent text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded px-1';
  ;['High','Medium','Low'].forEach(level=>{ const o=document.createElement('option'); o.value=level; o.text=level; if(level===t.priority) o.selected=true; prioritySelect.appendChild(o); });

  const del=document.createElement('button');
  del.className='absolute top-2 right-2 text-gray-400 hover:text-red-500';
  del.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
  del.title='Delete Task';

  const typingArea = document.createElement('div');
  typingArea.className = 'typing-area';

  function togglePH(){ placeholder.style.display = editable.innerText.trim()===''?'block':'none'; }
  togglePH();

  wrapper.addEventListener('dragstart', e=>{
    if(currentRole==='viewer'){ e.preventDefault(); return; }
    wrapper.classList.add('dragging'); e.dataTransfer.setData('text/plain', t.id);
    dragContext.id=t.id; dragContext.fromCol=wrapper.getAttribute('data-column');
  });
  wrapper.addEventListener('dragend', ()=> wrapper.classList.remove('dragging'));

  const sendTyping = debounce(()=> liveSend({ type:'presence/typing', taskId:t.id, tab:activeTab, name:displayNameFor(authedUser) }), 80);
  editable.addEventListener('input', ()=>{
    togglePH();
    const content = editable.innerText;
    patchTaskLocal(t.id, { content });
    liveSend({ type:'op', op:{ kind:'task/patch', tab:activeTab, taskId:t.id, patch:{ content } } });
    persistHTTP(); stampSync(); sendTyping();
  });
  editable.addEventListener('focus', ()=> sendTyping());
  dateInput.addEventListener('change', ()=>{
    const dueDate = normalizeDateString(dateInput.value);
    patchTaskLocal(t.id, { dueDate });
    liveSend({ type:'op', op:{ kind:'task/patch', tab:activeTab, taskId:t.id, patch:{ dueDate } } });
    persistHTTP(); stampSync();
  });
  prioritySelect.addEventListener('change', ()=>{
    const priority = prioritySelect.value || 'Medium';
    patchTaskLocal(t.id, { priority });
    liveSend({ type:'op', op:{ kind:'task/patch', tab:activeTab, taskId:t.id, patch:{ priority } } });
    persistHTTP(); stampSync();
  });
  del.onclick = ()=>{
    if(currentRole==='viewer') return;
    if(!confirm('Delete this task?')) return;
    removeTaskLocal(t.id);
    liveSend({ type:'op', op:{ kind:'task/remove', tab:activeTab, taskId:t.id } });
    persistHTTP(); stampSync();
  };

  wrapper.appendChild(editable); wrapper.appendChild(placeholder);
  row.appendChild(dateInput); row.appendChild(prioritySelect); wrapper.appendChild(row);
  wrapper.appendChild(del);
  wrapper.appendChild(typingArea);
  return wrapper;
}

function patchTaskLocal(taskId, patch){
  const tab = tabData[activeTab]; if(!tab) return;
  for (const c of COLS) {
    const list = tab[c] || [];
    const idx = list.findIndex(x=>x.id===taskId);
    if(idx!==-1){ list[idx] = { ...list[idx], ...patch, upd: Date.now(), by: currentUserKey }; return; }
  }
}
function removeTaskLocal(taskId){
  const tab = tabData[activeTab]; if(!tab) return;
  for (const c of COLS) {
    const list = tab[c] || [];
    const i = list.findIndex(x=>x.id===taskId);
    if(i!==-1){ list.splice(i,1); const node=document.querySelector(`[data-task-id="${taskId}"]`); if(node) node.remove(); return; }
  }
}
function addTaskLocal(col){
  const id = `task-${cryptoRandom()}`; const now = Date.now();
  const t = { id, content:'', dueDate:'', priority:'Medium', pos: (tabData[activeTab][col].slice(-1)[0]?.pos||0)+1, upd:now, by:currentUserKey };
  tabData[activeTab][col].push(t);
  const colEl = document.getElementById(col);
  const card = createTaskCard(t, col);
  colEl.appendChild(card);
  return t;
}
function moveTaskDomAndModel(taskId, fromCol, toCol, insertIndex, broadcast){
  const tab = tabData[activeTab];
  const fromList = tab[fromCol]||[]; const i=fromList.findIndex(t=>t.id===taskId); if(i===-1) return;
  const moved = fromList.splice(i,1)[0];
  const target = tab[toCol]||(tab[toCol]=[]);
  let idx = insertIndex==null?target.length:Math.max(0,Math.min(insertIndex,target.length));
  const prev = target[idx-1]?.pos, next = target[idx]?.pos;
  moved.pos = newPosBetween(prev,next); moved.upd=Date.now(); moved.by=currentUserKey;
  target.splice(idx,0,moved);

  const card = document.querySelector(`[data-task-id="${taskId}"]`);
  const colEl = document.getElementById(toCol);
  const tasks = [...colEl.querySelectorAll('.card')];
  if (idx >= tasks.length) colEl.appendChild(card);
  else colEl.insertBefore(card, tasks[idx]);
  card.setAttribute('data-column', toCol);

  if (broadcast){
    liveSend({ type:'op', op:{ kind:'task/move', tab:activeTab, taskId, fromCol, toCol, insertIndex: idx } });
    persistHTTP(); stampSync();
  }
}

function applyOpLocal(tabs, op){
  const k=op.kind;
  if(k==='tab/create'){
    if(!op.name||tabs[op.name]) return false;
    tabs[op.name]={todo:[], inprogress:[], done:[]}; // âœ… fixed colon
    renderTabs();
    return true;
  }
  if(k==='tab/rename'){
    const {from,to}=op; if(!from||!to||!tabs[from]||tabs[to]) return false;
    tabs[to]=tabs[from]; delete tabs[from];
    if(activeTab===from) activeTab=to; renderTabs(); if(activeTab===to) switchTab(to);
    return true;
  }
  if(k==='tab/delete'){
    const {name}=op; if(!name||!tabs[name]) return false;
    delete tabs[name];
    if(activeTab===name) { activeTab=Object.keys(tabs)[0]||null; renderTabs(); renderBoard(); } else { renderTabs(); }
    return true;
  }
  if(k==='tab/clear'){
    const {tab}=op; if(!tabs[tab]) tabs[tab]={todo:[],inprogress:[],done:[]}; else tabs[tab]={todo:[],inprogress:[],done:[]};
    if(activeTab===tab) renderBoard();
    return true;
  }

  if(k==='task/add'){
    const {tab,col,task}=op; if(!tabs[tab]) tabs[tab]={todo:[],inprogress:[],done:[]};
    const list=tabs[tab][col]||(tabs[tab][col]=[]);
    list.push({ ...task, pos:(list[list.length-1]?.pos||0)+1 });
    if(activeTab===tab){ const colEl=document.getElementById(col); colEl.appendChild(createTaskCard(task,col)); }
    return true;
  }
  if(k==='task/patch'){
    const {tab,taskId,patch}=op; const loc=findTaskLocal(tabs,tab,taskId); if(!loc) return false;
    const list=tabs[tab][loc.col]; const before=list[loc.idx];
    list[loc.idx]={...before,...patch,upd:Date.now()};
    if(activeTab===tab){
      const card=document.querySelector(`[data-task-id="${taskId}"]`);
      if(card){
        const focused = document.activeElement && card.contains(document.activeElement);
        if(!focused){
          if('content' in patch){ const e=card.querySelector('.editable'); if(e) e.innerText=patch.content||''; }
          if('dueDate' in patch){ const d=card.querySelector('input[type="date"]'); if(d) d.value=normalizeDateString(patch.dueDate)||''; }
          if('priority' in patch){ const s=card.querySelector('select'); if(s) s.value=patch.priority||'Medium'; }
        }
      }
    }
    return true;
  }
  if(k==='task/remove'){
    const {tab,taskId}=op; const loc=findTaskLocal(tabs,tab,taskId); if(!loc) return false;
    tabs[tab][loc.col].splice(loc.idx,1);
    if(activeTab===tab){ const node=document.querySelector(`[data-task-id="${taskId}"]`); if(node) node.remove(); }
    return true;
  }
  if(k==='task/move'){
    const {tab,taskId,fromCol,toCol,insertIndex}=op; if(!tabs[tab]) return false;
    const loc=findTaskLocal(tabs,tab,taskId); if(!loc) return false;
    const moved=tabs[tab][loc.col].splice(loc.idx,1)[0];
    const target=tabs[tab][toCol]||(tabs[tab][toCol]=[]);
    const idx=insertIndex==null?target.length:Math.max(0,Math.min(insertIndex,target.length));
    const prev=target[idx-1]?.pos, next=target[idx]?.pos;
    moved.pos=newPosBetween(prev,next); target.splice(idx,0,moved);
    if(activeTab===tab){ moveTaskDomAndModel(taskId, fromCol, toCol, idx, false); }
    return true;
  }
  return false;
}
function findTaskLocal(tabs, tab, id){
  const cols=COLS; if(!tabs[tab]) return null;
  for(const c of cols){ const list=tabs[tab][c]||[]; const i=list.findIndex(x=>x.id===id); if(i!==-1) return {col:c,idx:i}; }
  return null;
}
function newPosBetween(a,b){ const A=Number.isFinite(a)?+a:0; const B=Number.isFinite(b)?+b:A+2; return (B-A>1e-6)?A+(B-A)/2:A+0.000001; }

function mergeSnapshotIntoLocal(next){
  const curr = tabData;
  for(const k of Object.keys(next)) if(!curr[k]) curr[k]=next[k];
  for(const k of Object.keys(curr)) if(!(k in next)) delete curr[k];
  for(const tab of Object.keys(curr)){
    for(const col of COLS){
      const mine = curr[tab]?.[col]||[];
      const theirs = (next[tab]?.[col])||[];
      const map = new Map(mine.map(t=>[t.id,t]));
      for(const t of theirs){
        const ex = map.get(t.id);
        if(!ex){ mine.push(t); continue; }
        const card=document.querySelector(`[data-task-id="${t.id}"]`);
        const focused = card && document.activeElement && card.contains(document.activeElement);
        if(!focused){ ex.content = t.content; }
        ex.dueDate = t.dueDate; ex.priority = t.priority; ex.pos = t.pos; ex.upd = t.upd; ex.by = t.by;
      }
      for(let i=mine.length-1;i>=0;i--){ if(!theirs.find(x=>x.id===mine[i].id)) mine.splice(i,1); }
      if(activeTab===tab){
        const colEl = document.getElementById(col);
        const idsNow=[...colEl.querySelectorAll('.card')].map(n=>n.getAttribute('data-task-id'));
        const idsTarget=[...mine].sort((a,b)=>a.pos-b.pos).map(t=>t.id);
        if(idsNow.join('|')!==idsTarget.join('|')){
          colEl.querySelectorAll('.card')?.forEach(n=>n.remove());
          mine.sort((a,b)=>a.pos-b.pos).forEach(t=> colEl.appendChild(createTaskCard(t,col)));
        } else {
          mine.forEach(t=>{
            const card=document.querySelector(`[data-task-id="${t.id}"]`);
            if(!card) return;
            const focused = document.activeElement && card.contains(document.activeElement);
            if(!focused){ card.querySelector('.editable').innerText = t.content||''; }
            const d=card.querySelector('input[type="date"]'); if(d) d.value=normalizeDateString(t.dueDate)||'';
            const s=card.querySelector('select'); if(s) s.value=t.priority||'Medium';
          });
        }
      }
    }
  }
}

const dragContext = { id:null, fromCol:null, overCol:null, insertIndex:null };
function clearDrag(){ dragContext.id=null; dragContext.fromCol=null; dragContext.overCol=null; dragContext.insertIndex=null; }
function getAfter(container, y){
  const els=[...container.querySelectorAll('.card:not(.dragging)')];
  return els.reduce((closest,child)=>{ const box=child.getBoundingClientRect(); const off=y-box.top-box.height/2; if(off<0 && off>closest.offset){ return {offset:off, element:child}; } else return closest; },{offset:-Infinity}).element;
}
function computeInsertIndex(colEl, indicator){
  const siblings=[...colEl.querySelectorAll('.card')];
  if(siblings.length===0) return 0;
  const all=[...colEl.children]; let index=0;
  for(let i=0;i<all.length;i++){ const el=all[i]; if(el===indicator){ index=[...all.slice(0,i)].filter(n=>n.classList && n.classList.contains('card')).length; return index; } }
  return siblings.length;
}

function openMembers(){ document.getElementById('membersModal').classList.remove('hidden'); renderMembers(); }
function closeMembers(){ document.getElementById('membersModal').classList.add('hidden'); }
async function renderMembers(){
  const list = document.getElementById('membersList');
  list.innerHTML = '<div class="py-6 text-sm text-gray-500">Loadingâ€¦</div>';
  const shares = await listShares();
  list.innerHTML = '';
  shares.forEach(s=>{
    const row=document.createElement('div');
    row.className='flex items-center justify-between py-3';
    const who=document.createElement('div'); who.className='flex items-center gap-3';
    const bubble=document.createElement('div'); bubble.className='h-8 w-8 rounded-full bg-indigo-600/15 text-indigo-700 dark:text-indigo-300 flex items-center justify-center text-xs font-semibold';
    bubble.textContent = initials('', s.email||'');
    const meta=document.createElement('div');
    meta.innerHTML = `<div class="text-sm font-medium">${s.email||'â€”'}</div>`;
    who.appendChild(bubble); who.appendChild(meta);

    const actions=document.createElement('div'); actions.className='flex items-center gap-2';
    if (s.role === 'owner') {
      const tag=document.createElement('span'); tag.className='text-xs text-gray-500'; tag.textContent='owner';
      actions.appendChild(tag);
    } else if (currentRole==='owner' && s.id) {
      const sel=document.createElement('select');
      sel.className='text-xs border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-800';
      ['editor','viewer','owner'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.text=r; if(String(s.role||'editor')===r) o.selected=true; sel.appendChild(o); });
      sel.onchange = async ()=>{
        if(sel.value==='owner'){
          if(!confirm(`Transfer ownership to ${s.email}? You will lose owner privileges.`)) { sel.value = s.role||'editor'; return; }
          const r=await transferOwner(s.email||''); if(!r.ok){ alert('Failed to transfer'); sel.value=s.role||'editor'; } else { alert('Ownership transferred'); closeMembers(); location.reload(); }
          return;
        }
        const r=await patchShareRole(s.id, sel.value); if(!r.ok) alert('Failed to update role');
      };
      const del=document.createElement('button'); del.className='px-2 py-1 text-xs rounded bg-red-50 text-red-600 hover:bg-red-100'; del.textContent='Remove';
      del.onclick = async ()=>{ if(!confirm('Remove this member?')) return; const r=await removeShare(s.id); if(r.ok) renderMembers(); else alert('Failed to remove'); };
      actions.appendChild(sel); actions.appendChild(del);
    }

    row.appendChild(who); row.appendChild(actions); list.appendChild(row);
  });
}

document.getElementById('addTabBtn').onclick = ()=>{
  if(currentRole==='viewer') return;
  const name=(prompt('Enter tab name:')||'').trim();
  if(!name) return;
  if(tabData[name]){ switchTab(name); return; }
  tabData[name] = { todo:[], inprogress:[], done:[] };
  renderTabs(); switchTab(name);
  liveSend({ type:'op', op:{ kind:'tab/create', name } }); persistHTTP(); stampSync();
};
document.getElementById('newTaskBtn').onclick = ()=>{
  if(currentRole==='viewer') return;
  if(!activeTab){ const def='Click to edit'; tabData[def] = { todo:[], inprogress:[], done:[] }; activeTab=def; renderTabs(); switchTab(def); }
  const t = addTaskLocal('todo');
  liveSend({ type:'op', op:{ kind:'task/add', tab:activeTab, col:'todo', task:t } }); persistHTTP(); stampSync();
};
document.getElementById('clearBtn').onclick = ()=>{
  if(currentRole==='viewer') return;
  if(!activeTab) return;
  if(!confirm('Clear all tasks in this tab?')) return;
  tabData[activeTab] = { todo:[], inprogress:[], done:[] };
  COLS.forEach(c=>{ const colEl=document.getElementById(c); colEl.querySelectorAll('.card').forEach(n=>n.remove()); });
  liveSend({ type:'op', op:{ kind:'tab/clear', tab:activeTab } }); persistHTTP(); stampSync();
};
document.getElementById('exportBtn').onclick = ()=>{
  const board=document.getElementById('board');
  html2pdf().set({ margin:.5, filename:'Solara-Board.pdf', image:{type:'jpeg',quality:.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'letter', orientation:'landscape'} }).from(board).save();
};
document.getElementById('manageBtn').onclick = ()=>{ if(!WORKSPACE_ID) return alert('Open a workspace first.'); openMembers(); };

document.getElementById('userButton').onclick = ()=> document.getElementById('userMenu').classList.toggle('hidden');
document.getElementById('addUserBtn').onclick = ()=> openMembers();
document.getElementById('signOutBtn').onclick = async ()=>{
  try{ if(sessionJWT){ await fetch(apiUrl('logout'), { method:'POST', headers:{ 'Authorization':`Bearer ${sessionJWT}` } }).catch(()=>{}); } } finally {
    localStorage.removeItem('stytch_session_jwt'); localStorage.removeItem('solara_session_jwt'); location.replace('/sign-in.html');
  }
};

function setReportsHref(){
  const btn=document.getElementById('reportsLink');
  if(btn){ btn.onclick=()=>{ if(!WORKSPACE_ID){ alert('Open a workspace first.'); return; } location.href=`reports.html?ws=${encodeURIComponent(WORKSPACE_ID)}`; }; }
  const logo=document.getElementById('workspacesLink'); if(logo){ logo.href='workspace.html'; }
}

const dragContext = { id:null, fromCol:null, overCol:null, insertIndex:null };
function clearDrag(){ dragContext.id=null; dragContext.fromCol=null; dragContext.overCol=null; dragContext.insertIndex=null; }
function getAfter(container, y){
  const els=[...container.querySelectorAll('.card:not(.dragging)')];
  return els.reduce((closest,child)=>{ const box=child.getBoundingClientRect(); const off=y-box.top-box.height/2; if(off<0 && off>closest.offset){ return {offset:off, element:child}; } else return closest; },{offset:-Infinity}).element;
}
function computeInsertIndex(colEl, indicator){
  const siblings=[...colEl.querySelectorAll('.card')];
  if(siblings.length===0) return 0;
  const all=[...colEl.children]; let index=0;
  for(let i=0;i<all.length;i++){ const el=all[i]; if(el===indicator){ index=[...all.slice(0,i)].filter(n=>n.classList && n.classList.contains('card')).length; return index; } }
  return siblings.length;
}

async function boot(){
  const ok = await verifySessionAndHydrate();
  if(!ok){ location.replace('/sign-in.html'); return; }

  const url=new URL(location.href);
  WORKSPACE_ID = url.searchParams.get('ws') || localStorage.getItem('solara_last_ws') || '';
  if(!WORKSPACE_ID){ document.getElementById('wsBanner').classList.remove('hidden'); }
  else { localStorage.setItem('solara_last_ws', WORKSPACE_ID); }

  updateAuthUI();
  setReportsHref();

  currentRole = await fetchRole();
  const wlist = await fetch(apiUrl('workspaces'), { headers:{ 'Authorization':`Bearer ${sessionJWT}` }}).then(r=>r.ok?r.json():{workspaces:[]}).catch(()=>({workspaces:[]}));
  WORKSPACE_NAME = (wlist.workspaces||[]).find(w=>w.id===WORKSPACE_ID)?.name || '';
  document.getElementById('wsName').textContent = WORKSPACE_NAME || 'â€”';

  tabData = migrateShapes(await fetchTabs());
  if(Object.keys(tabData).length===0){ tabData['Click to edit']={ todo:[], inprogress:[], done:[] }; }
  activeTab = Object.keys(tabData)[0];
  renderTabs(); switchTab(activeTab);

  connectLive();

  setInterval(()=>{ fetch(apiUrl('presence/beat'), { method:'POST', headers:{ 'Authorization':`Bearer ${sessionJWT}`, 'Content-Type':'application/json' }, body: JSON.stringify({ workspace_id: WORKSPACE_ID }) }).catch(()=>{}); }, 30000);
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
