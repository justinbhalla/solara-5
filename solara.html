<!-- Key changes:
  - CLIENT_ID to tag updates; ignore echoed updates from self.
  - While typing, queue remote updates and apply after idle (800ms) or on blur.
  - Save debounce 500ms; save carries {meta}.
-->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Solara – Adaptive Workspace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    .drag-over{ background:rgba(99,102,241,.08); outline:2px dashed #6366f1; outline-offset:-2px }
    .menu-card{ box-shadow:0 10px 20px rgba(0,0,0,.08) }
    .editable{ outline:none; min-height:1.5rem }
    .dragging{ opacity:.6; transform:rotate(.4deg) }
    .drop-indicator{ height:.5rem; border-radius:.25rem; background:rgba(99,102,241,.45); margin:.25rem 0; display:none }
    .show-drop .drop-indicator{ display:block }
    .date-badge{ font-variant-numeric: tabular-nums }
    .presence-dot{ position:absolute; right:-2px; bottom:-2px; width:10px; height:10px; border-radius:999px; background:#10b981; border:2px solid white }
    .avatar{ position:relative }
    footer .slot{ min-width: 0 }
  </style>
</head>
<body class="flex flex-col min-h-screen bg-white text-gray-900 dark:bg-gray-900 dark:text-gray-100">
<!-- ...header/nav/board/footer/modal markup identical to your v10.1 (omitted for brevity) ... -->

<script>
/* ---------- CONFIG ---------- */
const API_BASE = "https://shy-smoke-ab8e.justinbhalla28.workers.dev";
const apiUrl = p => API_BASE.replace(/\/+$/,'') + '/' + String(p||'').replace(/^\/+/,'');

/* ---------- IDs & state ---------- */
const CLIENT_ID = (()=> {
  const k = 'solara_client_id';
  let v = localStorage.getItem(k);
  if (!v) { v = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)); localStorage.setItem(k, v); }
  return v;
})();

let WORKSPACE_ID='', WORKSPACE_NAME='', sessionJWT=null;
let authedUser=null, currentUserKey=null, currentRole='viewer';
const COLS=['todo','inprogress','done'];
let activeTab=null, tabData={}, ws=null, wsConnected=false;
let presence=new Map();
let lastSyncedAt=null;
let presenceBeatTimer=null, presencePollTimer=null, taskPollTimer=null;

/* typing / idle merge */
let editingTaskId=null;
let pendingRemoteTabs=null;
let idleApplyTimer=null;
const IDLE_APPLY_MS=800;

/* ---------- UTIL ---------- */
const debounce=(fn,ms=400)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
function getSessionJWT(){
  const m = document.cookie.match(/(?:^|; )(?:stytch_session_jwt|solara_session_jwt)=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : (localStorage.getItem('stytch_session_jwt') || localStorage.getItem('solara_session_jwt') || null);
}
function initials(name,email){ const parts=(name||'').trim().split(/\s+/).filter(Boolean); return parts.length?parts.slice(0,2).map(s=>s[0]).join('').toUpperCase():(email||'?').slice(0,2).toUpperCase(); }
function normalizeDateString(v){ if(!v) return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; const d=new Date(v); if(isNaN(d)) return ''; const tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().slice(0,10); }
function stampSync(){ lastSyncedAt=new Date(); const el=document.getElementById('lastSynced'); if(el) el.textContent='Last synced: '+lastSyncedAt.toLocaleTimeString(); }
const nowMeta=()=>({ clientId: CLIENT_ID, ts: Date.now() });

/* ---------- AUTH (same as before) ---------- */
function displayNameFor(u){ const f=u?.name?.first_name, l=u?.name?.last_name, e=u?.email_addresses?.[0]?.email_address; return [f,l].filter(Boolean).join(' ') || e || 'User'; }
function updateAuthUI(){ const name=displayNameFor(authedUser); const email=authedUser?.email_addresses?.[0]?.email_address||''; document.getElementById('avatar').textContent=initials(name,email); document.getElementById('userName').textContent=name; document.getElementById('userEmail').textContent=email; }
async function verifySessionAndHydrate(){
  sessionJWT=getSessionJWT(); if(!sessionJWT) return false;
  try{
    const r=await fetch(apiUrl('auth/check'),{headers:{Authorization:`Bearer ${sessionJWT}`}});
    if(!r.ok) return false;
    const data=await r.json();
    currentUserKey=data.user_id;
    const email=data.email ? [{email_address:data.email}] : [];
    const parts=(data.name||'').split(/\s+/); authedUser={ name:{first_name:parts[0]||'', last_name:parts.slice(1).join(' ')||'' }, email_addresses: email };
    localStorage.setItem('stytch_user', JSON.stringify(authedUser)); updateAuthUI(); return true;
  }catch{ return false; }
}

/* ---------- Shares/role/tasks/presence (mostly same) ---------- */
async function fetchRole(){ const r=await fetch(apiUrl(`workspaces/${encodeURIComponent(WORKSPACE_ID)}/role`),{headers:{Authorization:`Bearer ${sessionJWT}`}}); if(!r.ok) return 'viewer'; const j=await r.json().catch(()=>({})); return j.role||'viewer'; }
async function listShares(){ const r=await fetch(apiUrl(`shares?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`),{headers:{Authorization:`Bearer ${sessionJWT}`}}); if(!r.ok) return []; const j=await r.json().catch(()=>({shares:[]})); return j.shares||[]; }
async function invite(email){ return fetch(apiUrl('shares'),{method:'POST',headers:{Authorization:`Bearer ${sessionJWT}`,'Content-Type':'application/json'},body:JSON.stringify({workspace_id:WORKSPACE_ID,email})}); }
async function patchShareRole(id, role){ return fetch(apiUrl(`shares/${id}`),{method:'PATCH',headers:{Authorization:`Bearer ${sessionJWT}`,'Content-Type':'application/json'},body:JSON.stringify({role})}); }
async function removeShare(id){ return fetch(apiUrl(`shares/${id}`),{method:'DELETE',headers:{Authorization:`Bearer ${sessionJWT}`}}); }
async function transferOwner(toEmail){ return fetch(apiUrl(`workspaces/${encodeURIComponent(WORKSPACE_ID)}/transfer_owner`),{method:'POST',headers:{Authorization:`Bearer ${sessionJWT}`,'Content-Type':'application/json'},body:JSON.stringify({to_email:toEmail})}); }

async function fetchTabs(){ const r=await fetch(apiUrl(`tasks?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`),{headers:{Authorization:`Bearer ${sessionJWT}`}}); if(!r.ok) return {}; const j=await r.json().catch(()=>({tabs:{}})); return j.tabs||{}; }
async function saveTabsHTTP(tabs, meta){ await fetch(apiUrl('tasks'),{method:'POST',headers:{Authorization:`Bearer ${sessionJWT}`,'Content-Type':'application/json'},body:JSON.stringify({workspace_id:WORKSPACE_ID,tabs,meta})}); }

async function presenceBeatHTTP(){ try{ await fetch(apiUrl('presence/beat'),{method:'POST',headers:{Authorization:`Bearer ${sessionJWT}`,'Content-Type':'application/json'},body:JSON.stringify({workspace_id:WORKSPACE_ID})}); }catch{} }
async function presencePollHTTP(){ try{ const r=await fetch(apiUrl(`presence?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`),{headers:{Authorization:`Bearer ${sessionJWT}`}}); if(!r.ok) return; const j=await r.json().catch(()=>({online:[]})); presence.clear(); (j.online||[]).forEach(p=>{ if(p.id!==currentUserKey) presence.set(p.id,{name:p.name,email:p.email}); }); renderPresence(); }catch{} }

/* ---------- Live WS with echo suppression ---------- */
function liveUrl(){ try{ const u=new URL(API_BASE); u.pathname=(u.pathname.replace(/\/+$/,'')+'/live').replace(/\/{2,}/g,'/'); u.search=`?ws=${encodeURIComponent(WORKSPACE_ID)}&token=${encodeURIComponent(sessionJWT)}`; u.protocol=u.protocol.replace('http','ws'); return u.toString(); }catch{ return null; } }
function connectLive(){
  const url=liveUrl(); if(!url){ startHTTPFallback(); return; }
  try{ ws=new WebSocket(url); }catch{ startHTTPFallback(); return; }
  ws.onopen=()=>{ wsConnected=true; stopTaskPolling(); };
  ws.onclose=()=>{ wsConnected=false; startHTTPFallback(); };
  ws.onerror=()=>{ wsConnected=false; startHTTPFallback(); };
  ws.onmessage=(ev)=>{
    let msg={}; try{ msg=JSON.parse(ev.data||'{}'); }catch{}
    if(msg.type==='hello'){
      currentUserKey = msg.you?.user_id || currentUserKey;
      presence.clear(); (msg.online||[]).forEach(p=>presence.set(p.id,{name:p.name,email:p.email})); renderPresence();
      tabData = migrateShapes(msg.tabs||{}); if(Object.keys(tabData).length===0){ tabData['Click to edit']={todo:[],inprogress:[],done:[]}; }
      if(!activeTab) activeTab=Object.keys(tabData)[0]; renderTabs(); switchTab(activeTab); stampSync(); return;
    }
    if(msg.type==='tabs:set' && msg.ws===WORKSPACE_ID){
      // Ignore our own echo
      if (msg.meta && msg.meta.clientId && msg.meta.clientId === CLIENT_ID) { stampSync(); return; }
      // If user is typing, queue and apply after idle
      if (editingTaskId){ pendingRemoteTabs = msg.tabs || {}; idleScheduleApply(); return; }
      tabData = migrateShapes(msg.tabs||{}); if(!tabData[activeTab]) activeTab = Object.keys(tabData)[0]||activeTab;
      renderTabs(); switchTab(activeTab); stampSync(); return;
    }
    if(msg.type==='presence/join'){ if(msg.by && msg.by!==currentUserKey){ presence.set(msg.by,{name:msg.name||'',email:msg.email||''}); renderPresence(); } return; }
    if(msg.type==='presence/leave'){ presence.delete(msg.by); renderPresence(); return; }
  };
}
function liveSend(obj){ if(ws && ws.readyState===1){ try{ ws.send(JSON.stringify({ ...obj, ws: WORKSPACE_ID })); }catch{} } }

/* ---------- Presence UI (same look) ---------- */
function renderPresence(){
  const avatars=document.getElementById('presenceAvatars');
  const list=document.getElementById('presenceList');
  const count=document.getElementById('presenceCount');
  if(!avatars||!list||!count) return;
  avatars.innerHTML=''; list.innerHTML='';
  const others=[...presence.entries()].map(([id,v])=>({id,...v})).sort((a,b)=>(a.name||a.email).localeCompare(b.name||b.email));
  count.textContent = others.length ? '' : '0 online';
  const max=4;
  others.slice(0,max).forEach(p=>{
    const span=document.createElement('span');
    span.className='avatar inline-flex items-center justify-center h-7 w-7 rounded-full bg-indigo-600/10 text-indigo-700 dark:text-indigo-300 text-[11px] font-semibold ring-2 ring-white';
    span.title=p.name||p.email; span.textContent=initials(p.name,p.email);
    const dot=document.createElement('span'); dot.className='presence-dot'; span.appendChild(dot);
    avatars.appendChild(span);
    const row=document.createElement('div');
    row.className='flex items-center gap-2';
    row.innerHTML=`<div class="relative inline-flex items-center justify-center h-6 w-6 rounded-full bg-indigo-600/10 text-indigo-700 dark:text-indigo-300 text-[10px] font-semibold">
      ${initials(p.name,p.email)}<span class="presence-dot" style="right:-1px;bottom:-1px;width:8px;height:8px"></span></div>
      <div class="truncate">${p.name||p.email}</div>`;
    list.appendChild(row);
  });
  if(others.length>max){
    const extra=others.length-max; const more=document.createElement('span');
    more.className='avatar inline-flex items-center justify-center h-7 w-7 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 text-[11px] font-semibold ring-2 ring-white';
    more.textContent=`+${extra}`; avatars.appendChild(more);
  }
}
document.getElementById('presenceBtn')?.addEventListener('click',()=>document.getElementById('presenceTooltip')?.classList.toggle('hidden'));

/* ---------- Tabs/board/render ---------- */
function migrateShapes(data){
  const out=JSON.parse(JSON.stringify(data||{}));
  Object.keys(out).forEach(tab=>{
    COLS.forEach(col=>{
      let pos=1;
      out[tab][col]=(out[tab][col]||[]).map(t=>({
        id: t.id||`task-${cryptoRandom()}`,
        content: typeof t.content==='string'?t.content:'',
        dueDate: normalizeDateString(t.dueDate),
        priority: ['High','Medium','Low'].includes(t.priority)?t.priority:'Medium',
        pos: Number.isFinite(+t.pos)?+t.pos:pos++,
        upd: Number.isFinite(+t.upd)?+t.upd:Date.now(),
        by: t.by||currentUserKey||'unknown'
      }));
    });
  });
  return out;
}
function cryptoRandom(){ try{ return crypto.randomUUID(); }catch{ return Math.random().toString(36).slice(2); } }

function renderTabs(){
  const node=document.getElementById('tabs'); if(!node) return; node.innerHTML='';
  Object.keys(tabData).forEach(name=>{
    const b=document.createElement('button');
    b.className='tab-button px-4 py-1.5 rounded-full text-sm font-medium bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-white transition-all duration-150 truncate max-w-[160px]';
    if(name===activeTab){ b.classList.add('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30'); }
    b.dataset.tab=name; b.textContent=name;
    b.onclick=()=>{ switchTab(name); };
    b.ondblclick=()=>{ if(currentRole==='viewer') return; const nn=prompt('Rename tab:',name); if(!nn||!nn.trim()||nn===name||tabData[nn])return; tabData[nn]=tabData[name]; delete tabData[name]; if(activeTab===name) activeTab=nn; renderTabs(); switchTab(activeTab); pushTabs(); };
    b.oncontextmenu=(e)=>{ e.preventDefault(); if(currentRole==='viewer')return; if(confirm(`Delete tab "${name}"?`)){ delete tabData[name]; if(activeTab===name) activeTab=Object.keys(tabData)[0]||null; renderTabs(); renderBoard(); pushTabs(); } };
    node.appendChild(b);
  });
}
function switchTab(tab){ if(!tabData[tab]) return; activeTab=tab; document.querySelectorAll('.tab-button').forEach(x=>x.classList.remove('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30')); const btn=[...document.querySelectorAll('.tab-button')].find(b=>b.dataset.tab===tab); if(btn) btn.classList.add('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30'); renderBoard(); }
function ensureAtLeastOne(){ const cols=tabData[activeTab]; if(!cols) return; if((cols.todo?.length||0)+(cols.inprogress?.length||0)+(cols.done?.length||0)===0){ const id=`task-${cryptoRandom()}`; cols.todo.push({ id, content:'', dueDate:'', priority:'Medium', pos:1, upd:Date.now(), by: currentUserKey }); } }

function createTaskElement(id, content='', dueDate='', priority='Medium', column, pos){
  const w=document.createElement('div');
  w.id=id; w.setAttribute('data-task','1'); w.draggable=currentRole!=='viewer';
  w.className='relative p-3 rounded bg-white dark:bg-gray-700 shadow cursor-move mb-2'; w.setAttribute('data-column',column);

  const editable=document.createElement('div'); editable.className='editable w-full font-medium mb-1'; editable.contentEditable=(currentRole!=='viewer'); editable.innerText=content;
  const placeholder=document.createElement('span'); placeholder.className='absolute left-3 top-3 text-sm text-gray-400 pointer-events-none'; placeholder.textContent='Click to edit...';
  function toggle(){ placeholder.style.display = editable.innerText.trim()===''?'block':'none'; }

  const row=document.createElement('div'); row.className='flex items-center gap-2';
  const dateInput=document.createElement('input'); dateInput.type='date'; dateInput.value=normalizeDateString(dueDate)||''; dateInput.disabled=(currentRole==='viewer'); dateInput.className='mt-1 text-xs bg-transparent text-gray-700 dark:text-gray-200 border border-transparent rounded px-1 date-badge';
  const prioritySelect=document.createElement('select'); prioritySelect.disabled=(currentRole==='viewer'); prioritySelect.className='mt-1 ml-2 text-xs bg-transparent text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded px-1';
  ['High','Medium','Low'].forEach(level=>{ const o=document.createElement('option'); o.value=level; o.text=level; if(level===priority) o.selected=true; prioritySelect.appendChild(o); });
  const del=document.createElement('button'); del.className='absolute top-2 right-2 text-gray-400 hover:text-red-500'; del.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'; del.title='Delete Task'; del.onclick=()=>{ if(currentRole==='viewer')return; if(confirm('Delete this task?')) removeTaskById(id); };

  // typing state
  editable.addEventListener('focus', ()=>{ editingTaskId = id; });
  editable.addEventListener('blur', ()=>{ editingTaskId = null; if(pendingRemoteTabs){ tabData=migrateShapes(pendingRemoteTabs); pendingRemoteTabs=null; renderTabs(); switchTab(activeTab); stampSync(); } });

  editable.addEventListener('input', ()=>{ toggle(); persistTaskEdits(id,{ content: editable.innerText.trim() }); idleScheduleApply(); });
  dateInput.addEventListener('change', ()=> persistTaskEdits(id,{ dueDate: normalizeDateString(dateInput.value) }));
  prioritySelect.addEventListener('change', ()=> persistTaskEdits(id,{ priority: prioritySelect.value||'Medium' }));

  w.addEventListener('dragstart',e=>{ if(currentRole==='viewer'){ e.preventDefault(); return; } w.classList.add('dragging'); e.dataTransfer.setData('text/plain',id); dragContext.id=id; dragContext.fromCol=w.getAttribute('data-column'); });
  w.addEventListener('dragend',()=>{ w.classList.remove('dragging'); });

  row.appendChild(dateInput); row.appendChild(prioritySelect);
  w.appendChild(editable); w.appendChild(placeholder); w.appendChild(row); w.appendChild(del);
  toggle();
  return w;
}
function idleScheduleApply(){ clearTimeout(idleApplyTimer); idleApplyTimer = setTimeout(()=>{ if(!editingTaskId && pendingRemoteTabs){ tabData=migrateShapes(pendingRemoteTabs); pendingRemoteTabs=null; renderTabs(); switchTab(activeTab); stampSync(); } }, IDLE_APPLY_MS); }

const dragContext = { id:null, fromCol:null, overCol:null, insertIndex:null };
function clearDrag(){ dragContext.id=null; dragContext.fromCol=null; dragContext.overCol=null; dragContext.insertIndex=null; }
function getAfter(container, y){
  const els=[...container.querySelectorAll('[data-task]:not(.dragging)')];
  return els.reduce((closest,child)=>{ const box=child.getBoundingClientRect(); const off=y-box.top-box.height/2; if(off<0 && off>closest.offset){ return {offset:off, element:child}; } else return closest; },{offset:-Infinity}).element;
}
function computeInsertIndex(colEl, indicator){
  const siblings=[...colEl.querySelectorAll('[data-task]')];
  if(siblings.length===0) return 0;
  const all=[...colEl.children]; let index=0;
  for(let i=0;i<all.length;i++){ const el=all[i]; if(el===indicator){ index=[...all.slice(0,i)].filter(n=>n.hasAttribute && n.hasAttribute('data-task')).length; return index; } }
  return siblings.length;
}
function newPosBetween(prev, next){ const A=Number.isFinite(prev)?+prev:0; const B=Number.isFinite(next)?+next:A+2; if(B-A>1e-6) return A+(B-A)/2; return A+0.000001; }
function reindex(list){ list.forEach((t,i)=> t.pos=i+1); }

function renderBoard(){
  ['todo','inprogress','done'].forEach(col=>{
    const colEl=document.getElementById(col);
    colEl.querySelectorAll('[data-task]')?.forEach(n=>n.remove());
    colEl.ondragover=(e)=>{ e.preventDefault(); colEl.classList.add('drag-over','show-drop'); const after=getAfter(colEl,e.clientY); const ind=colEl.querySelector('.drop-indicator'); if(after==null){ colEl.appendChild(ind);} else { colEl.insertBefore(ind,after);} dragContext.overCol=col; dragContext.insertIndex=computeInsertIndex(colEl, ind); };
    colEl.ondragleave=()=>{ colEl.classList.remove('drag-over','show-drop'); };
    colEl.ondrop=(e)=>{ e.preventDefault(); colEl.classList.remove('drag-over','show-drop'); const id=dragContext.id; if(!id) return; commitReorder(id, dragContext.fromCol, col, dragContext.insertIndex); clearDrag(); };
  });

  if(!activeTab || !tabData[activeTab]) return;
  ensureAtLeastOne();
  const data=tabData[activeTab];
  COLS.forEach(col=>{
    const colEl=document.getElementById(col);
    (data[col]||[]).sort((a,b)=>(a.pos||0)-(b.pos||0)).forEach(t=> colEl.appendChild(createTaskElement(t.id,t.content,t.dueDate,t.priority,col,t.pos)));
  });
}

/* ---------- Mutations + push (longer debounce, meta) ---------- */
function persistTaskEdits(taskId, patch){
  if(!activeTab || !tabData[activeTab]) return;
  for(const col of COLS){
    const list=tabData[activeTab][col]||[];
    const idx=list.findIndex(t=>t.id===taskId);
    if(idx!==-1){
      if('dueDate' in patch) patch.dueDate = normalizeDateString(patch.dueDate);
      list[idx] = { ...list[idx], ...patch, upd: Date.now(), by: currentUserKey };
      break;
    }
  }
  pushTabs();
}
function removeTaskById(taskId){
  if(!activeTab || !tabData[activeTab]) return;
  for(const col of COLS){
    const list=tabData[activeTab][col]||[];
    const idx=list.findIndex(t=>t.id===taskId);
    if(idx!==-1){ list.splice(idx,1); break; }
  }
  renderBoard(); pushTabs();
}
function clearAllTasks(){
  if(currentRole==='viewer') return;
  if(!activeTab) return;
  if(!confirm('Clear all tasks in this tab?')) return;
  tabData[activeTab] = { todo:[], inprogress:[], done:[] };
  renderBoard(); pushTabs();
}
function addNewTask(){
  if(currentRole==='viewer') return;
  if(!activeTab){ const def='Click to edit'; if(!tabData[def]) tabData[def]={ todo:[], inprogress:[], done:[] }; activeTab=def; renderTabs(); }
  const id=`task-${cryptoRandom()}`; const now=Date.now();
  const t={ id, content:'', dueDate:'', priority:'Medium', pos:(tabData[activeTab].todo.slice(-1)[0]?.pos||0)+1, upd:now, by:currentUserKey };
  tabData[activeTab].todo.push(t); renderBoard(); pushTabs();
}
function commitReorder(taskId, fromCol, toCol, insertIndex){
  if(currentRole==='viewer') return;
  const cols=tabData[activeTab];
  let moved; const fromList=cols[fromCol]||[]; const i=fromList.findIndex(t=>t.id===taskId);
  if(i!==-1){ moved=fromList.splice(i,1)[0]; }
  if(!moved) return;
  const target=cols[toCol]=cols[toCol]||[];
  if(insertIndex==null||insertIndex<0) insertIndex=target.length;
  if(insertIndex>target.length) insertIndex=target.length;
  const prev=target[insertIndex-1]?.pos, next=target[insertIndex]?.pos;
  moved.pos=newPosBetween(prev,next); moved.upd=Date.now(); moved.by=currentUserKey;
  target.splice(insertIndex,0,moved);
  if(!Number.isFinite(prev)||!Number.isFinite(next)||Math.abs((next||moved.pos)-(prev||0))<1e-6){ reindex(target); }
  renderBoard(); pushTabs();
}
const pushTabs = debounce(()=> {
  const meta = nowMeta();
  try { liveSend({ type:'tabs:update', tabs: tabData, meta }); } catch {}
  saveTabsHTTP(tabData, meta).catch(()=>{});
  stampSync();
}, 500);

/* ---------- Members UI + boot (same UI, minor tweaks) ---------- */
// ... keep your previous handlers for members, export, sign out, reports, etc.

function stopTaskPolling(){ if(taskPollTimer){ clearInterval(taskPollTimer); taskPollTimer=null; } }
function startHTTPFallback(){
  if(!presenceBeatTimer){ presenceBeatHTTP(); presenceBeatTimer=setInterval(presenceBeatHTTP,10000); }
  if(!presencePollTimer){ presencePollHTTP(); presencePollTimer=setInterval(presencePollHTTP,5000); }
  if(!taskPollTimer){
    taskPollTimer=setInterval(async ()=>{
      try{
        const serverTabs=migrateShapes(await fetchTabs());
        const localJSON=JSON.stringify(tabData);
        const remoteJSON=JSON.stringify(serverTabs);
        if(remoteJSON!==localJSON && !editingTaskId){
          tabData=serverTabs;
          if(!tabData[activeTab]) activeTab=Object.keys(tabData)[0]||activeTab;
          renderTabs(); switchTab(activeTab); stampSync();
        } else if (remoteJSON!==localJSON && editingTaskId){
          pendingRemoteTabs=serverTabs; idleScheduleApply();
        }
      }catch{}
    }, 2000);
  }
}

async function boot(){
  const ok=await verifySessionAndHydrate(); if(!ok){ location.replace('/sign-in.html'); return; }
  const url=new URL(location.href);
  WORKSPACE_ID = url.searchParams.get('ws') || localStorage.getItem('solara_last_ws') || '';
  if(!WORKSPACE_ID){ document.getElementById('wsBanner')?.classList.remove('hidden'); } else { localStorage.setItem('solara_last_ws', WORKSPACE_ID); }
  updateAuthUI();

  // role + workspace name
  currentRole = await fetchRole();
  const wlist = await fetch(apiUrl('workspaces'), { headers:{ Authorization:`Bearer ${sessionJWT}` }}).then(r=>r.ok?r.json():{workspaces:[]}).catch(()=>({workspaces:[]}));
  const row=(wlist.workspaces||[]).find(w=>w.id===WORKSPACE_ID);
  WORKSPACE_NAME=row?.name||''; document.getElementById('wsName').textContent=WORKSPACE_NAME||'—';
  if(row && row.owner_id===currentUserKey) currentRole='owner';

  // bootstrap tasks
  tabData=migrateShapes(await fetchTabs());
  if(Object.keys(tabData).length===0){ tabData['Click to edit']={todo:[],inprogress:[],done:[]}; }
  activeTab=Object.keys(tabData)[0]; renderTabs(); switchTab(activeTab);

  // start fallback immediately, then WS
  startHTTPFallback();
  connectLive();
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
