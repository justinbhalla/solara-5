<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Solara â€“ Adaptive Workspace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    .fade-in{animation:fadeIn .25s ease-in-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .drag-over{background:rgba(99,102,241,.08);outline:2px dashed #6366f1;outline-offset:-2px}
    .menu-card{box-shadow:0 10px 20px rgba(0,0,0,.08)}
    .editable{outline:none;min-height:1.5rem}
    .dragging{opacity:.6;transform:rotate(.5deg)}
    .drop-indicator{height:.5rem;border-radius:.25rem;background:rgba(99,102,241,.45);margin:.25rem 0;display:none}
    .show-drop .drop-indicator{display:block}
    .date-badge{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="flex flex-col min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <div id="wsBanner" class="hidden bg-amber-50 text-amber-900 border-b border-amber-200 px-6 py-2 text-sm">
    No workspace selected. <a class="underline font-medium" href="workspace.html">Go to Workspaces</a>
  </div>

  <!-- Header -->
  <header class="flex justify-between items-center px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
    <div class="flex items-center gap-3">
      <a id="workspacesLink" href="workspace.html" class="w-9 h-9 rounded-xl bg-indigo-600/10 text-indigo-600 flex items-center justify-center hover:bg-indigo-600/20" title="Back to Workspaces">ðŸ”·</a>
      <div>
        <h1 class="text-3xl font-bold tracking-tight">Solara</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400">Part of the ZLG Product Suite</p>
      </div>
    </div>

    <div class="flex items-center gap-4">
      <!-- Presence thumbnails (others only) -->
      <div class="relative">
        <button id="presenceBtn" class="flex -space-x-2">
          <span id="presenceAvatars" class="flex -space-x-2"></span>
          <span id="presenceCount" class="ml-2 text-xs text-gray-500"></span>
        </button>
        <div id="presenceTooltip" class="hidden absolute right-0 mt-2 w-64 rounded-xl menu-card bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 p-3 text-sm shadow">
          <div class="font-semibold mb-2">Online now</div>
          <div id="presenceList" class="space-y-1 max-h-56 overflow-auto"></div>
        </div>
      </div>

      <!-- User -->
      <div id="userArea" class="relative">
        <button id="userButton" class="flex items-center gap-2 px-3 py-2 rounded-full border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
          <span id="avatar" class="inline-flex h-7 w-7 items-center justify-center rounded-full bg-indigo-600 text-white text-xs font-semibold">?</span>
          <span id="userName" class="text-sm font-medium">User</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
        </button>
        <div id="userMenu" class="hidden absolute right-0 mt-2 w-56 rounded-xl menu-card bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 overflow-hidden">
          <div class="px-4 py-3 text-sm">
            <div id="userEmail" class="text-gray-600 dark:text-gray-300"></div>
          </div>
          <div class="border-t border-gray-100 dark:border-gray-700"></div>
          <button id="addUserBtn" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700">Add userâ€¦</button>
          <button id="signOutBtn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Nav -->
  <nav class="flex items-center justify-between px-6 py-2 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm font-medium">
    <div class="flex items-center gap-6">
      <button class="flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-semibold">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3h14v2H3V3zm0 4h9v2H3V7zm0 4h14v2H3v-2zm0 4h9v2H3v-2z"/></svg>
        <span>Tasks</span>
      </button>
      <button id="reportsLink" class="flex items-center gap-2 text-gray-700 dark:text-gray-200 hover:text-indigo-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18M7 16v-4m4 4V8m4 8V5"/></svg>
        <span>Reports</span>
      </button>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="clearAllTasks()" class="p-2 rounded-full bg-red-100 text-red-600 hover:bg-red-200 transition-all" title="Clear all tasks in current tab">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m0 0A2.99 2.99 0 017 6h10a2.99 2.99 0 012.418 3H19v10a2 2 0 01-2 2H7a2 2 0 01-2-2V9h.582zM10 11v6m4-6v6"/></svg>
      </button>
      <button id="newTaskBtn" onclick="addNewTask()" class="px-4 py-1.5 text-sm rounded bg-indigo-600 text-white hover:bg-indigo-500 shadow transition">+</button>
    </div>
  </nav>

  <!-- Main Board -->
  <main class="p-6 flex-1 overflow-y-auto">
    <div id="board" class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div id="todo" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="todo">
        <h2 class="text-lg font-semibold mb-2">To Do</h2>
        <div class="drop-indicator"></div>
      </div>
      <div id="inprogress" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="inprogress">
        <h2 class="text-lg font-semibold mb-2">In Progress</h2>
        <div class="drop-indicator"></div>
      </div>
      <div id="done" class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-sm" data-col="done">
        <h2 class="text-lg font-semibold mb-2">Done</h2>
        <div class="drop-indicator"></div>
      </div>
    </div>
  </main>

  <!-- Tabs rail + Footer -->
  <div class="sticky bottom-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 z-50">
    <div class="flex items-center justify-between px-6 py-3 overflow-x-auto">
      <div class="flex items-center gap-2 w-full overflow-x-auto px-1 py-1">
        <div id="tabs" class="flex gap-2 min-w-max"></div>
        <button onclick="promptNewTab()" title="Add Tab" class="p-2 rounded-full bg-green-100 hover:bg-green-200 text-green-700 transition duration-150 shadow-sm border border-green-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        </button>
      </div>
      <div class="flex items-center gap-1">
        <button id="manageBtn" onclick="openMembers()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition" title="Manage members">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.57-.906 3.435.96 2.53 2.53a1.724 1.724 0 001.065 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.906 1.57-.96 3.435-2.53 2.53a1.724 1.724 0 00-2.573 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.57.906-3.435-.96-2.53-2.53A1.724 1.724 0 003.087 13.9c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.906-1.57.96-3.435 2.53-2.53.98.565 2.229.11 2.642-1.13zM12 9a3 3 0 110 6 3 3 0 010-6z"/></svg>
        </button>
        <button onclick="exportBoardAsPDF()" class="ml-1 p-2 rounded-full hover:bg-indigo-100 text-indigo-600 transition" title="Download Board">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zm-7 4h14v-2H5v2z"/></svg>
        </button>
      </div>
    </div>

    <!-- Footer grid -->
    <div class="border-t border-gray-200 dark:border-gray-700">
      <div class="grid grid-cols-3 items-center px-6 py-3">
        <div class="text-xs text-gray-500 dark:text-gray-400"><span id="footerWorkspaceName">Workspace: â€”</span></div>
        <div class="text-xs text-gray-500 dark:text-gray-400 text-center">Â© 2025 ZenLock Group (ZLG). All rights reserved.</div>
        <div class="text-xs text-gray-500 dark:text-gray-400 text-right"><span id="footerLastSynced">Last synced: â€”</span></div>
      </div>
    </div>
  </div>

  <!-- Members Modal -->
  <div id="membersModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40" onclick="closeMembers()"></div>
    <div class="relative w-full max-w-lg rounded-2xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 p-5 shadow-xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Workspace Members</h3>
        <button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800" onclick="closeMembers()" title="Close">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <!-- Invite row (owner only) -->
      <div id="inviteRow" class="flex gap-2 mb-3 hidden">
        <input id="inviteEmail" type="email" placeholder="name@example.com" class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm"/>
        <button onclick="inviteMember()" class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-500 text-sm">Invite</button>
      </div>

      <!-- Simple aligned list + owner controls on right -->
      <div id="membersList" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
    </div>
  </div>

<script>
/******** CONFIG ********/
const API_BASE = "https://shy-smoke-ab8e.justinbhalla28.workers.dev";
const apiUrl = p => API_BASE.replace(/\/+$/,'') + '/' + String(p||'').replace(/^\/+/,'');

/******** STATE ********/
let WORKSPACE_ID = '';
let WORKSPACE_NAME = 'â€”';
let LAST_SYNCED_AT = null;

let sessionJWT = null;
let authedUser = null;
let currentUserKey = null;
let currentRole = 'viewer';

let tabData = {};
let activeTab = null;

let liveSocket = null;
let liveBeat = null;
const presence = new Map(); // user_id -> {name,email,at}

const COLS = ['todo','inprogress','done'];
const debounce = (fn,ms=200)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

/******** UTIL ********/
function getSessionJWT(){
  const m = document.cookie.match(/(?:^|; )(?:stytch_session_jwt|solara_session_jwt)=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : (localStorage.getItem('stytch_session_jwt') || localStorage.getItem('solara_session_jwt') || null);
}
function normalizeDateString(s){ if(!s) return ''; if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const d=new Date(s); if(isNaN(d)) return ''; const tz=d.getTimezoneOffset()*60000; return new Date(d.getTime()-tz).toISOString().slice(0,10); }
function initials(name='', email=''){ const parts=String(name).trim().split(/\s+/).filter(Boolean); return parts.length?parts.slice(0,2).map(s=>s[0].toUpperCase()).join(''):(email||'?').slice(0,2).toUpperCase(); }
function displayNameFor(u){ const parts=[u?.name?.first_name,u?.name?.last_name].filter(Boolean); return parts.length?parts.join(' '):(u?.email_addresses?.[0]?.email_address||''); }
function escapeHTML(s=''){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
function formatStamp(ts){ if(!ts) return 'â€”'; const d=new Date(ts); if(isNaN(d)) return 'â€”'; return d.toLocaleString([], {year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
function updateFooter(){ document.getElementById('footerWorkspaceName').textContent = `Workspace: ${WORKSPACE_NAME||'â€”'}`; document.getElementById('footerLastSynced').textContent = `Last synced: ${formatStamp(LAST_SYNCED_AT)}`; }

/******** AUTH ********/
function hydrateFromAuthCheckPayload(data){
  const full=(data?.name||'').trim(); const parts=full?full.split(/\s+/):[]; const first=parts[0]||''; const last=parts.slice(1).join(' ')||'';
  const email=data?.email||''; const uid=data?.user_id||email||'anon';
  currentUserKey=uid;
  return { name:{first_name:first,last_name:last}, email_addresses: email?[{email_address:email}]:[] };
}
function updateAuthUI(){
  const u=authedUser||{name:{},email_addresses:[]};
  const full = displayNameFor(u); const email=u?.email_addresses?.[0]?.email_address||'';
  document.getElementById('avatar').textContent = initials(full, email);
  document.getElementById('userName').textContent = full || 'User';
  document.getElementById('userEmail').textContent = email;
}
async function verifySessionAndHydrate(){
  sessionJWT = getSessionJWT();
  authedUser = JSON.parse(localStorage.getItem('stytch_user')||'null');
  if(!sessionJWT) return false;
  try{
    const r=await fetch(apiUrl('auth/check'), { headers:{ Authorization:`Bearer ${sessionJWT}` }});
    if(!r.ok) return false;
    const data=await r.json();
    const fresh = hydrateFromAuthCheckPayload(data);
    if(!authedUser){ authedUser=fresh; } else {
      if (fresh.email_addresses?.[0]?.email_address && !authedUser.email_addresses?.length) authedUser.email_addresses=fresh.email_addresses;
      if ((fresh.name?.first_name||fresh.name?.last_name) && !(authedUser.name?.first_name||authedUser.name?.last_name)) authedUser.name=fresh.name;
    }
    localStorage.setItem('stytch_user', JSON.stringify(authedUser));
    updateAuthUI();
    return true;
  }catch{ return !!authedUser; }
}
function requireReauth(){ try{ localStorage.removeItem('stytch_session_jwt'); localStorage.removeItem('solara_session_jwt'); }catch{} location.replace('/sign-in.html'); }
document.getElementById('userButton').onclick=()=> document.getElementById('userMenu').classList.toggle('hidden');
document.addEventListener('click',(e)=>{ const m=document.getElementById('userMenu'), b=document.getElementById('userButton'); if(!m.classList.contains('hidden') && !m.contains(e.target) && !b.contains(e.target)) m.classList.add('hidden'); });
document.getElementById('signOutBtn').onclick=()=>requireReauth();
document.getElementById('addUserBtn').onclick=()=>openMembers();

/******** Presence (header) ********/
document.getElementById('presenceBtn').onclick=()=> document.getElementById('presenceTooltip').classList.toggle('hidden');
function presenceRender(){
  const others = Array.from(presence.values()).filter(p => p.id !== currentUserKey && Date.now() - (p.at||0) < 30000);
  const avatars = document.getElementById('presenceAvatars');
  const count = document.getElementById('presenceCount');
  const tooltip = document.getElementById('presenceList');
  avatars.innerHTML=''; tooltip.innerHTML='';
  others.slice(0,4).forEach(p=>{
    const span=document.createElement('span');
    span.className='inline-flex items-center justify-center h-7 w-7 rounded-full bg-indigo-600/10 text-indigo-700 dark:text-indigo-300 text-[11px] font-semibold ring-2 ring-white';
    span.title=p.name||p.email; span.textContent=initials(p.name,p.email);
    avatars.appendChild(span);
    const row=document.createElement('div'); row.className='flex items-center gap-2';
    row.innerHTML=`<div class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-indigo-600/10 text-indigo-700 dark:text-indigo-300 text-[10px] font-semibold">${initials(p.name,p.email)}</div><div class="truncate">${escapeHTML(p.name||p.email)}</div>`;
    tooltip.appendChild(row);
  });
  count.textContent = others.length ? '' : '0 online';
}
function presenceJoin(){ liveSend({ type:'presence/join' }); touchSelfPresence(); }
function presenceBeat(){ liveSend({ type:'presence/beat' }); touchSelfPresence(); }
function presenceLeave(){ try{ liveSend({ type:'presence/leave' }); }catch{} }
function touchSelfPresence(){
  const email=authedUser?.email_addresses?.[0]?.email_address||''; const name=displayNameFor(authedUser)||email||'You';
  presence.set(currentUserKey, { id: currentUserKey, name, email, at: Date.now() }); presenceRender();
}

/******** LIVE (WS) ********/
function liveUrl(){
  try{
    const base=new URL(API_BASE); base.pathname=(base.pathname.replace(/\/+$/,'') + '/live').replace(/\/{2,}/g,'/');
    base.search=`?ws=${encodeURIComponent(WORKSPACE_ID)}&token=${encodeURIComponent(sessionJWT||'')}`;
    base.protocol=base.protocol.replace('http','ws'); return base.toString();
  }catch{ return null; }
}
let liveSocket=null, liveBeat=null;
function liveConnect(){
  const u=liveUrl(); if(!u) return; let ws;
  try{ ws=new WebSocket(u); }catch{ return; }
  liveSocket=ws;
  ws.onopen=()=>{ presenceJoin(); if(liveBeat) clearInterval(liveBeat); liveBeat=setInterval(presenceBeat,20000); };
  ws.onmessage=(ev)=>{
    let msg={}; try{ msg=JSON.parse(ev.data||'{}'); }catch{}
    if(!msg||typeof msg!=='object') return;
    if(msg.ws && msg.ws!==WORKSPACE_ID) return;

    if (msg.type==='hello'){
      if (msg.tabs && Object.keys(msg.tabs).length){ tabData=migrateTaskShapes(msg.tabs); renderTabs(); switchTab(Object.keys(tabData)[0]||activeTab); LAST_SYNCED_AT=msg.ts; updateFooter(); }
      if (msg.you && currentUserKey!==msg.you) currentUserKey=msg.you;
      presenceRender(); return;
    }
    if (msg.type==='presence/join' || msg.type==='presence/beat'){
      presence.set(msg.by, { id:msg.by, name:msg.name||'', email:msg.email||'', at:Date.now() }); presenceRender(); return;
    }
    if (msg.type==='presence/leave'){ presence.delete(msg.by); presenceRender(); return; }
    if (msg.type==='tabs'){
      if (msg.by===currentUserKey){ LAST_SYNCED_AT=msg.ts; updateFooter(); return; }
      tabData=migrateTaskShapes(msg.tabs||{}); renderTabs(); if(!activeTab) activeTab=Object.keys(tabData)[0]||null; switchTab(activeTab); LAST_SYNCED_AT=msg.ts; updateFooter(); return;
    }
  };
  ws.onclose=()=>{ if(liveBeat){ clearInterval(liveBeat); liveBeat=null; } };
}
function liveSend(obj){ if(!liveSocket||liveSocket.readyState!==1) return; try{ liveSocket.send(JSON.stringify(obj)); }catch{} }

/******** HTTP Sync Fallback ********/
async function fetchCloudTabs(){
  try{
    const r=await fetch(apiUrl('tasks')+`?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`,{ headers:{ Authorization:`Bearer ${sessionJWT}` }});
    if(!r.ok) return null;
    const data=await r.json(); LAST_SYNCED_AT=data?.ts||Date.now(); updateFooter(); return data?.tabs||{};
  }catch{ return null; }
}
const saveTabsHTTP = debounce(async ()=>{
  try{
    const r=await fetch(apiUrl('tasks'),{ method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${sessionJWT}` }, body: JSON.stringify({ workspace_id: WORKSPACE_ID, tabs: tabData }) });
    if(r.ok){ const o=await r.json().catch(()=>({})); LAST_SYNCED_AT=o?.ts||Date.now(); updateFooter(); }
  }catch{}
}, 150);

/******** Data shape ********/
function migrateTaskShapes(data){
  const out=JSON.parse(JSON.stringify(data||{}));
  Object.keys(out||{}).forEach(tab=>{
    COLS.forEach(col=>{
      let posCounter=1;
      out[tab][col]=(out[tab][col]||[]).map(t=>({
        id: t.id || `task-${cryptoRandom()}`,
        content: typeof t.content==='string'?t.content:'',
        dueDate: normalizeDateString(t.dueDate),
        priority: ['High','Medium','Low'].includes(t.priority)?t.priority:'Medium',
        pos: isFinite(Number(t.pos))?Number(t.pos):posCounter++,
        upd: isFinite(Number(t.upd))?Number(t.upd):Date.now(),
        by: t.by || (currentUserKey||'unknown')
      }));
    });
  });
  return out;
}
function cryptoRandom(){ try{ return crypto.randomUUID(); }catch{ return Math.random().toString(36).slice(2); } }

/******** Tabs UI ********/
function renderTabs(){
  const c=document.getElementById('tabs'); c.innerHTML='';
  const names=Object.keys(tabData);
  names.forEach(name=>{
    const btn=document.createElement('button');
    btn.className='tab-button px-4 py-1.5 rounded-full text-sm font-medium bg-transparent border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-white transition-all duration-150 truncate max-w-[160px]';
    if(name===activeTab) btn.classList.add('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30');
    btn.dataset.tab=name; btn.innerHTML=`<span>${name}</span>`;
    btn.onclick=()=>switchTab(name);
    btn.ondblclick=()=>{
      if(currentRole==='viewer') return;
      const nn=prompt('Rename tab:', name); if(!nn||!nn.trim()||nn===name||tabData[nn]) return;
      tabData[nn]=tabData[name]; delete tabData[name];
      if(activeTab===name) activeTab=nn;
      renderTabs(); switchTab(activeTab);
      pushTabs();
    };
    btn.oncontextmenu=(e)=>{ e.preventDefault(); deleteTab(name); };
    c.appendChild(btn);
  });
}
function promptNewTab(){ if(currentRole==='viewer') return; const name=prompt('Enter tab name:'); if(!name||!name.trim()) return; addTab(name.trim()); }
function addTab(name){ if(tabData[name]) return switchTab(name); tabData[name]={ todo:[], inprogress[], done:[] }; renderTabs(); switchTab(name); pushTabs(); }
function deleteTab(name){ if(currentRole==='viewer') return; if(!confirm(`Delete tab "${name}" and all its tasks?`)) return; delete tabData[name]; if(activeTab===name) activeTab=Object.keys(tabData)[0]||null; renderTabs(); renderBoard(); pushTabs(); }
function switchTab(tabName){
  if(!tabData[tabName]) return; activeTab=tabName;
  document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30'));
  const activeBtn=Array.from(document.querySelectorAll('.tab-button')).find(b=>b.dataset.tab===tabName); if(activeBtn) activeBtn.classList.add('border-indigo-500','text-indigo-700','dark:text-white','font-semibold','bg-indigo-50','dark:bg-indigo-600/30');
  renderBoard();
}
function ensureAtLeastOneTask(){ const cols=tabData[activeTab]; if(!cols) return; if((cols.todo?.length||0)+(cols.inprogress?.length||0)+(cols.done?.length||0)===0){ const id=`task-${cryptoRandom()}`; cols.todo.push({ id, content:'', dueDate:'', priority:'Medium', pos:1, upd:Date.now(), by: currentUserKey }); } }
function renderBoard(){
  COLS.forEach(col=>{
    const el=document.getElementById(col);
    el.querySelectorAll('[data-task]')?.forEach(n=>n.remove());
    el.ondragover=(e)=>{
      e.preventDefault(); el.classList.add('drag-over','show-drop');
      const after=getDragAfterElement(el,e.clientY); const indicator=el.querySelector('.drop-indicator');
      if(after==null){ el.appendChild(indicator);} else { el.insertBefore(indicator, after); }
      dragContext.overCol=el.dataset.col; dragContext.insertIndex=computeInsertIndex(el, indicator);
    };
    el.ondragleave=()=>el.classList.remove('drag-over','show-drop');
    el.ondrop=(e)=>{ e.preventDefault(); el.classList.remove('drag-over','show-drop'); const id=dragContext.id; if(!id) return; commitReorder(id, dragContext.fromCol, el.dataset.col, dragContext.insertIndex); clearDragContext(); };
  });
  if(!activeTab || !tabData[activeTab]) return;
  ensureAtLeastOneTask();
  const data=tabData[activeTab];
  COLS.forEach(col=>{
    const el=document.getElementById(col);
    (data[col]||[]).sort((a,b)=> (a.pos||0)-(b.pos||0)).forEach(t=> el.appendChild(createTaskElement(t.id,t.content,t.dueDate,t.priority,col,t.pos)));
  });
}
function createTaskElement(id, content='', dueDate='', priority='Medium', column){
  const w=document.createElement('div');
  w.id=id; w.setAttribute('data-task','1'); w.draggable=currentRole!=='viewer';
  w.className='relative p-3 rounded bg-white dark:bg-gray-700 shadow cursor-move mb-2'; w.setAttribute('data-column', column);

  const editable=document.createElement('div'); editable.className='editable w-full font-medium mb-1'; editable.contentEditable=currentRole!=='viewer'; editable.innerText=content;
  const placeholder=document.createElement('span'); placeholder.className='absolute left-3 top-3 text-sm text-gray-400 pointer-events-none'; placeholder.textContent='Click to edit...';
  const row=document.createElement('div'); row.className='flex items-center gap-2';
  const dateInput=document.createElement('input'); dateInput.type='date'; dateInput.value=normalizeDateString(dueDate)||''; dateInput.disabled=(currentRole==='viewer'); dateInput.className='mt-1 text-xs bg-transparent text-gray-700 dark:text-gray-200 border border-transparent rounded px-1 date-badge';
  const pri=document.createElement('select'); pri.disabled=(currentRole==='viewer'); pri.className='mt-1 ml-2 text-xs bg-transparent text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-600 rounded px-1'; ['High','Medium','Low'].forEach(p=>{ const o=document.createElement('option'); o.value=p; o.text=p; if(p===priority) o.selected=true; pri.appendChild(o); });
  const del=document.createElement('button'); del.className='absolute top-2 right-2 text-gray-400 hover:text-red-500'; del.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'; del.title='Delete Task'; del.onclick=()=>{ if(currentRole==='viewer') return; if(confirm('Delete this task?')) removeTaskById(id); };

  w.addEventListener('dragstart', e=>{ if(currentRole==='viewer'){ e.preventDefault(); return;} w.classList.add('dragging'); e.dataTransfer.setData('text/plain', id); dragContext.id=id; dragContext.fromCol=w.getAttribute('data-column'); });
  w.addEventListener('dragend', ()=> w.classList.remove('dragging'));
  const togglePH=()=> placeholder.style.display = editable.innerText.trim()==='' ? 'block' : 'none';

  editable.addEventListener('input', ()=>{ togglePH(); persistTaskEdits(id,{ content:editable.innerText.trim() }); });
  editable.addEventListener('blur', ()=> persistTaskEdits(id,{ content:editable.innerText.trim() }));
  dateInput.addEventListener('change', ()=> persistTaskEdits(id,{ dueDate: normalizeDateString(dateInput.value) }));
  pri.addEventListener('change', ()=> persistTaskEdits(id,{ priority: pri.value||'Medium' }));

  row.appendChild(dateInput); row.appendChild(pri);
  w.appendChild(editable); w.appendChild(placeholder); w.appendChild(row); w.appendChild(del);
  togglePH();
  return w;
}
let dragContext={ id:null, fromCol:null, overCol:null, insertIndex:null };
function clearDragContext(){ dragContext={ id:null, fromCol:null, overCol:null, insertIndex:null }; }
function getDragAfterElement(container, y){
  const els=[...container.querySelectorAll('[data-task]:not(.dragging)')];
  return els.reduce((closest,child)=>{ const box=child.getBoundingClientRect(); const offset=y - box.top - box.height/2; return (offset<0 && offset>closest.offset)?{offset,element:child}:closest; }, {offset:-Infinity}).element;
}
function computeInsertIndex(colEl, indicator){
  const siblings=[...colEl.querySelectorAll('[data-task]')];
  if(siblings.length===0) return 0;
  const all=[...colEl.children]; let index=0;
  for(let i=0;i<all.length;i++){ const el=all[i]; if(el===indicator){ index=[...all.slice(0,i)].filter(n=>n.hasAttribute && n.hasAttribute('data-task')).length; return index; } }
  return siblings.length;
}
function commitReorder(taskId, fromCol, toCol, insertIndex){
  if(currentRole==='viewer') return; if(!activeTab||!tabData[activeTab]) return;
  const cols=tabData[activeTab];
  const from=cols[fromCol]||[]; const i=from.findIndex(t=>t.id===taskId); if(i===-1) return;
  const moved=from.splice(i,1)[0]; const target=cols[toCol]=cols[toCol]||[];
  if(insertIndex==null||insertIndex<0) insertIndex = target.length; if(insertIndex>target.length) insertIndex=target.length;
  const prev=target[insertIndex-1]?.pos; const next=target[insertIndex]?.pos;
  const A=isFinite(prev)?Number(prev):0; const B=isFinite(next)?Number(next):(isFinite(prev)?A+2:2);
  moved.pos = (B-A>1e-6) ? A+(B-A)/2 : A + 0.000001;
  moved.upd=Date.now(); moved.by=currentUserKey;
  target.splice(insertIndex,0,moved);
  if(!isFinite(prev)||!isFinite(next)||Math.abs((next||moved.pos)-(prev||0))<1e-6){ target.forEach((t,i)=> t.pos=i+1); }
  renderBoard(); pushTabs();
}

/******** Mutations -> Live ********/
function persistTaskEdits(taskId, patch){
  if(currentRole==='viewer') return; if(!activeTab||!tabData[activeTab]) return;
  for(const col of COLS){ const list=tabData[activeTab][col]||[]; const idx=list.findIndex(t=>t.id===taskId); if(idx!==-1){ if('dueDate' in patch) patch.dueDate=normalizeDateString(patch.dueDate); list[idx]={ ...list[idx], ...patch, upd:Date.now(), by: currentUserKey }; break; } }
  pushTabs();
}
function removeTaskById(taskId){
  if(currentRole==='viewer') return; if(!activeTab||!tabData[activeTab]) return;
  for(const col of COLS){ const list=tabData[activeTab][col]||[]; const idx=list.findIndex(t=>t.id===taskId); if(idx!==-1){ list.splice(idx,1); break; } }
  renderBoard(); pushTabs();
}
function clearAllTasks(){
  if(currentRole==='viewer') return; if(!activeTab) return; if(!confirm('Clear all tasks in this tab?')) return;
  tabData[activeTab] = { todo:[], inprogress:[], done:[] }; renderBoard(); pushTabs();
}
function addNewTask(){
  if(currentRole==='viewer') return;
  if(!activeTab){ const def='Click to edit'; if(!tabData[def]) tabData[def]={ todo:[], inprogress:[], done:[] }; activeTab=def; renderTabs(); }
  const id=`task-${cryptoRandom()}`; const now=Date.now();
  const t={ id, content:'', dueDate:'', priority:'Medium', pos:(tabData[activeTab].todo.slice(-1)[0]?.pos||0)+1, upd:now, by: currentUserKey };
  tabData[activeTab].todo.push(t); renderBoard(); pushTabs();
}
const pushTabs = debounce(()=>{
  if (liveSocket && liveSocket.readyState===1) { liveSend({ type:'tabs:set', tabs: tabData }); }
  saveTabsHTTP();
}, 120);

/******** Members: owner controls (role + remove) ********/
let cachedMembers = [];
async function fetchMembers(){
  const r=await fetch(apiUrl('members')+`?workspace_id=${encodeURIComponent(WORKSPACE_ID)}`,{ headers:{ Authorization:`Bearer ${sessionJWT}` }});
  if(!r.ok) return [];
  const data=await r.json().catch(()=>({members:[]}));
  return data.members||[];
}
async function computeRole(){
  try{
    const ws = await fetch(apiUrl('workspaces'),{ headers:{ Authorization:`Bearer ${sessionJWT}`}}).then(r=>r.ok?r.json():{workspaces:[]}).catch(()=>({workspaces:[]}));
    const row=(ws.workspaces||[]).find(w=>w.id===WORKSPACE_ID);
    if (row && row.owner_id === currentUserKey) return 'owner';
  }catch{}
  return 'viewer';
}
async function patchShare(id, role){
  const r=await fetch(apiUrl(`shares/${id}`),{ method:'PATCH', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${sessionJWT}` }, body: JSON.stringify({ role }) });
  return r.ok;
}
async function deleteShare(id){
  const r=await fetch(apiUrl(`shares/${id}`),{ method:'DELETE', headers:{ Authorization:`Bearer ${sessionJWT}` }});
  return r.ok;
}
function openMembers(){
  if(!WORKSPACE_ID){ alert('Open a workspace to manage members.'); return;}
  document.getElementById('membersModal').classList.remove('hidden');
  loadMembers();
}
function closeMembers(){ document.getElementById('membersModal').classList.add('hidden'); }
async function loadMembers(){
  const list=document.getElementById('membersList');
  list.innerHTML='<div class="py-6 text-sm text-gray-500">Loadingâ€¦</div>';
  cachedMembers = await fetchMembers();
  currentRole = await computeRole();

  // Owner-only invite row
  document.getElementById('inviteRow').classList.toggle('hidden', currentRole!=='owner');

  list.innerHTML='';
  if(!cachedMembers.length){ list.innerHTML='<div class="py-6 text-sm text-gray-500">No members yet.</div>'; return; }

  cachedMembers.forEach(m=>{
    const row=document.createElement('div'); row.className='flex items-center justify-between py-3';
    const left=document.createElement('div'); left.className='flex items-center gap-3 min-w-0';
    const bubble=document.createElement('div'); bubble.className='h-8 w-8 rounded-full bg-indigo-600/15 text-indigo-700 dark:text-indigo-300 flex items-center justify-center text-xs font-semibold';
    bubble.textContent = initials(m.name||'', m.email||'');
    const meta=document.createElement('div'); meta.className='truncate';
    meta.textContent = (m.name && m.name.trim()) ? m.name : (m.email || 'â€”');
    left.appendChild(bubble); left.appendChild(meta);
    row.appendChild(left);

    const right=document.createElement('div'); right.className='flex items-center gap-2';
    if(currentRole==='owner' && m.role!=='owner' && m.share_id){
      const sel=document.createElement('select');
      sel.className='text-xs border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-800';
      ['editor','viewer'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.text=r; if(String(m.role||'editor')===r) o.selected=true; sel.appendChild(o); });
      sel.onchange=async ()=>{
        const ok=await patchShare(m.share_id, sel.value);
        if(!ok){ alert('Failed to update role'); sel.value = String(m.role||'editor'); }
        else { m.role = sel.value; }
      };

      const del=document.createElement('button');
      del.className='px-2 py-1 text-xs rounded bg-red-50 text-red-600 hover:bg-red-100';
      del.textContent='Remove';
      del.onclick=async ()=>{
        if(!confirm(`Remove ${meta.textContent}?`)) return;
        const ok=await deleteShare(m.share_id);
        if(!ok) return alert('Failed to remove');
        await loadMembers();
      };

      right.appendChild(sel); right.appendChild(del);
    }
    row.appendChild(right);
    list.appendChild(row);
  });
}
async function inviteMember(){
  const input=document.getElementById('inviteEmail');
  const email=(input.value||'').trim().toLowerCase(); if(!email) return alert('Enter an email.');
  if(!WORKSPACE_ID) return alert('No workspace selected.');
  const r=await fetch(apiUrl('shares'),{ method:'POST', headers:{ 'Content-Type':'application/json', Authorization:`Bearer ${sessionJWT}` }, body: JSON.stringify({ email, workspace_id: WORKSPACE_ID }) });
  const b=await r.json().catch(()=>({}));
  if(!r.ok) return alert('Invite failed: '+(b?.error||r.status));
  input.value='';
  await loadMembers();
  if (b.invite_link) { try{ await navigator.clipboard.writeText(b.invite_link);}catch{} alert('Invitation created. Link copied.'); }
}

/******** Export ********/
function exportBoardAsPDF(){
  const board=document.getElementById('board');
  html2pdf().set({ margin:.5, filename:'Solara-Board.pdf', image:{type:'jpeg',quality:.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'letter',orientation:'landscape'} }).from(board).save();
}

/******** Boot ********/
function maybeAttachLastWorkspace(){
  const url=new URL(location.href);
  if(url.searchParams.get('ws')) return;
  const last=localStorage.getItem('solara_last_ws'); if(last){ url.searchParams.set('ws', last); history.replaceState(null,'',url.toString()); }
}
function setReportsHref(){
  const btn=document.getElementById('reportsLink'); if(btn){ btn.onclick=()=>{ if(!WORKSPACE_ID){ alert('Open a workspace first.'); return; } location.href=`reports.html?ws=${encodeURIComponent(WORKSPACE_ID)}`; }; }
  const logo=document.getElementById('workspacesLink'); if(logo) logo.href='workspace.html';
}

async function initialLoad(){
  maybeAttachLastWorkspace();
  const url=new URL(location.href);
  WORKSPACE_ID = url.searchParams.get('ws')||'';
  if(!WORKSPACE_ID){ document.getElementById('wsBanner').classList.remove('hidden'); }

  const ok=await verifySessionAndHydrate(); if(!ok) return requireReauth();
  setReportsHref();

  // Workspace name
  try{
    const wsRes=await fetch(apiUrl('workspaces'),{ headers:{ Authorization:`Bearer ${sessionJWT}` }});
    if(wsRes.ok){ const data=await wsRes.json(); const row=(data.workspaces||[]).find(w=>w.id===WORKSPACE_ID); if(row){ WORKSPACE_NAME=row.name||'â€”'; } }
  }catch{}
  updateFooter();

  // Initial tabs
  const REMOTE = await fetchCloudTabs();
  tabData = migrateTaskShapes(REMOTE||{});
  if(Object.keys(tabData).length===0){ const def='Click to edit'; tabData[def]={ todo:[], inprogress:[], done:[] }; }
  activeTab = Object.keys(tabData)[0];
  renderTabs(); switchTab(activeTab);

  // Live
  liveConnect();

  // Fallback poll
  setInterval(async ()=>{
    if (!liveSocket || liveSocket.readyState!==1){
      const snap=await fetchCloudTabs(); if(snap){ tabData=migrateTaskShapes(snap); renderTabs(); if(!activeTab) activeTab=Object.keys(tabData)[0]||null; switchTab(activeTab); }
    }
  }, 20000);
}

window.addEventListener('beforeunload', presenceLeave);
document.addEventListener('DOMContentLoaded', initialLoad);
</script>
</body>
</html>
